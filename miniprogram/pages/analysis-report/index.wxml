<!--pages/analysis-report/index.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else class="content">
    <!-- ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ -->
    <view class="statistics-card">
      <view class="stats-header">
        <text class="stats-title">æ£€æµ‹æŠ¥å‘Šæ¦‚è§ˆ</text>
        <text wx:if="{{statistics.lastReportDate}}" class="stats-date">æœ€è¿‘æ£€æµ‹ï¼š{{statistics.lastReportDate}}</text>
      </view>
      
      <view class="stats-content">
        <view class="stat-item">
          <text class="stat-number">{{statistics.totalReports}}</text>
          <text class="stat-label">æ€»æŠ¥å‘Šæ•°</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number" style="color: #4CAF50;">{{statistics.normalRate}}%</text>
          <text class="stat-label">æ­£å¸¸ç‡</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number" style="color: #F44336;">{{statistics.abnormalCount}}</text>
          <text class="stat-label">å¼‚å¸¸æŠ¥å‘Š</text>
        </view>
      </view>
    </view>

    <!-- æŠ¥å‘Šç±»å‹ç­›é€‰å™¨ -->
    <view class="filter-section">
      <scroll-view class="filter-scroll" scroll-x="true" show-scrollbar="false">
        <view class="filter-item {{filterType === 'all' ? 'active' : ''}}" 
              bindtap="onFilterChange" data-type="all">
          <text class="filter-icon">ğŸ“Š</text>
          <text class="filter-text">å…¨éƒ¨</text>
        </view>
        <view class="filter-item {{filterType === 'blood_ms' ? 'active' : ''}}" 
              bindtap="onFilterChange" data-type="blood_ms">
          <text class="filter-icon">ğŸ©¸</text>
          <text class="filter-text">è¡€ä¸²è”è´¨è°±</text>
        </view>
        <view class="filter-item {{filterType === 'urine_ms' ? 'active' : ''}}" 
              bindtap="onFilterChange" data-type="urine_ms">
          <text class="filter-icon">ğŸ§ª</text>
          <text class="filter-text">å°¿ä¸²è”è´¨è°±</text>
        </view>
        <view class="filter-item {{filterType === 'blood_gas' ? 'active' : ''}}" 
              bindtap="onFilterChange" data-type="blood_gas">
          <text class="filter-icon">ğŸ’¨</text>
          <text class="filter-text">è¡€æ°”åˆ†æ</text>
        </view>
        <view class="filter-item {{filterType === 'blood_ammonia' ? 'active' : ''}}" 
              bindtap="onFilterChange" data-type="blood_ammonia">
          <text class="filter-icon">âš¡</text>
          <text class="filter-text">è¡€æ°¨æ£€æµ‹</text>
        </view>
      </scroll-view>
    </view>

    <!-- æŠ¥å‘Šåˆ—è¡¨ -->
    <view class="report-list">
      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{reportList.length === 0}}" class="empty-state">
        <view class="empty-icon">ğŸ“‹</view>
        <text class="empty-title">æš‚æ— æ£€æµ‹æŠ¥å‘Š</text>
        <text class="empty-desc">ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªæŠ¥å‘Š</text>
      </view>

      <!-- æŠ¥å‘Šå¡ç‰‡åˆ—è¡¨ -->
      <view wx:else class="report-cards">
        <view wx:for="{{reportList}}" wx:key="_id" class="report-card" 
              bindtap="onViewReport" data-report-id="{{item._id}}">
          
          <!-- å¡ç‰‡å¤´éƒ¨ -->
          <view class="card-header">
            <view class="card-date">
              <text class="date-text">{{item.formattedDate}}</text>
              <text class="report-type">{{item.reportTypeName}}</text>
            </view>
            <view class="card-actions">
              <view class="action-btn" catchtap="onEditReport" 
                    data-report-id="{{item._id}}">
                <text class="action-icon">âœï¸</text>
              </view>
              <view class="action-btn" catchtap="onDeleteReport" 
                    data-report-id="{{item._id}}" data-index="{{index}}">
                <text class="action-icon">ğŸ—‘ï¸</text>
              </view>
            </view>
          </view>

          <!-- å¡ç‰‡å†…å®¹ -->
          <view class="card-content">
            <view class="summary-stats">
              <view class="summary-item">
                <text class="summary-label">æ€»æŒ‡æ ‡</text>
                <text class="summary-value">{{item.summary.totalCount}}</text>
              </view>
              <view class="summary-item">
                <text class="summary-label">æ­£å¸¸</text>
                <text class="summary-value normal">{{item.summary.normalCount}}</text>
              </view>
              <view class="summary-item">
                <text class="summary-label">å¼‚å¸¸</text>
                <text class="summary-value abnormal">{{item.summary.abnormalCount}}</text>
              </view>
              <view class="summary-item">
                <text class="summary-label">æ­£å¸¸ç‡</text>
                <text class="summary-value rate">{{item.summary.normalRate}}%</text>
              </view>
            </view>
          </view>

          <!-- å¡ç‰‡åº•éƒ¨çŠ¶æ€ -->
          <view class="card-footer">
            <view class="status-indicator {{item.summary.abnormalCount > 0 ? 'abnormal' : 'normal'}}">
                {{item.summary.abnormalCount > 0 ? 'å­˜åœ¨å¼‚å¸¸æŒ‡æ ‡' : 'æŒ‡æ ‡æ­£å¸¸'}}
            </view>
            <view class="view-detail">
              <text class="detail-text">æŸ¥çœ‹è¯¦æƒ…</text>
              <text class="detail-arrow">â†’</text>
            </view>
          </view>
        </view>
      </view>

      <!-- åŠ è½½æ›´å¤š -->
      <view wx:if="{{loadingMore}}" class="loading-more">
        <text class="loading-more-text">åŠ è½½æ›´å¤š...</text>
      </view>
      
      <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
      <view wx:elif="{{!hasMore && reportList.length > 0}}" class="no-more">
        <text class="no-more-text">æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
      </view>
    </view>
  </view>

  <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’® -->
  <view class="fab-container">
    <button class="fab-button" bindtap="onAddReport">
      <text class="fab-icon">+</text>
    </button>
  </view>
</view>