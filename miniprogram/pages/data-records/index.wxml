<view class="container">
  <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
  <view class="date-selector">
    <!-- å½“å‰æ—¥æœŸæ˜¾ç¤º -->
    <view class="current-date">
      <text class="date-text">{{todayFullDate}}</text>
    </view>
    
    <!-- æ—¥æœŸæ»‘åŠ¨åŒºåŸŸ -->
    <view class="date-scroll-container">
      <scroll-view 
        scroll-x="true" 
        scroll-into-view="{{currentDateId}}" 
        scroll-with-animation="true" 
        class="date-list" 
        enhanced="true"
        show-scrollbar="false"
        enable-flex="{{false}}"
        bounces="{{true}}"
        fast-deceleration="{{true}}"
      >
        <view class="date-items-container">
          <view 
            id="date-{{index}}" 
            class="date-item {{selectedDateIndex === index ? 'selected' : ''}} {{index === 0 ? 'today' : ''}}" 
            wx:for="{{dateList}}" 
            wx:key="date" 
            data-date="{{item.date}}" 
            data-index="{{index}}" 
            bindtap="onDateItemClick"
          >
            <text class="weekday">{{item.weekday}}</text>
            <text class="day">{{item.day}}</text>
            <text class="month">{{item.month}}æœˆ</text>
          </view>
          
          <view class="date-more-indicator" bindtap="showCalendar">
            <text>æ›´å¤š</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- è®°å½•å†…å®¹åŒºåŸŸ -->
  <view class="records-wrapper" style="opacity: {{isDataLoading ? 0.5 : 1}};">
    <!-- æ—¥æœŸæ˜¾ç¤ºå¤´éƒ¨ -->
    <view class="date-header">
      <view class="selected-date">{{formattedSelectedDate}}</view>
      <view class="calendar-icon" bindtap="showCalendar">æ—¥å†</view>
    </view>

    <!-- æ— è®°å½•æç¤º -->
    <view class="empty-data" wx:if="{{feedingRecords.length === 0 && medicationRecords.length === 0}}" style="opacity: {{isDataLoading ? 0.5 : 1}}; transition: opacity 0.3s;">
      <view class="empty-icon">ğŸ“</view>
      <view class="empty-text">å½“æ—¥æš‚æ— è®°å½•</view>
      <view class="empty-actions">
        <view class="add-btn" bindtap="showAddFeedingModal">
          <image class="add-icon" src="/images/icons/add.svg" mode="aspectFit"></image>
          <text>è¡¥å……å–‚å¥¶è®°å½•</text>
        </view>
        <view class="add-btn" bindtap="showAddMedicationModal">
          <image class="add-icon" src="/images/icons/add.svg" mode="aspectFit"></image>
          <text>è¡¥å……ç”¨è¯è®°å½•</text>
        </view>
      </view>
    </view>

    <!-- æœ‰è®°å½•æ—¶æ˜¾ç¤ºå†…å®¹ -->
    <block wx:else>
      <!-- å–‚å¥¶è®°å½•æ±‡æ€»å¡ç‰‡ -->
      <view class="card">
        <view class="card-title">
          <text>æ±‡æ€»ä¿¡æ¯</text>
        </view>
        
        <!-- ç”Ÿé•¿ä¿¡æ¯ -->
        <view class="growth-info">
          <view class="growth-item">
            <view class="growth-label">ä½“é‡</view>
            <view class="growth-value">{{weight}} kg</view>
          </view>
          <view class="growth-item">
            <view class="growth-label">èº«é«˜</view>
            <view class="growth-value">{{height}} cm</view>
          </view>
        </view>
        
        <!-- å–‚å¥¶ä¿¡æ¯ -->
        <view class="total-summary">
          <view class="total-item">
            <view class="total-label">æ€»å¥¶é‡</view>
            <view class="total-value">{{totalMilk}}ml</view>
          </view>
          <view class="total-item">
            <view class="total-label">å¤©ç„¶å¥¶æ€»é‡</view>
            <view class="total-value">{{totalNaturalMilk}}ml</view>
          </view>
          <view class="total-item">
            <view class="total-label">ç‰¹å¥¶æ€»é‡</view>
            <view class="total-value">{{totalSpecialMilk}}ml</view>
          </view>
          <view class="total-item">
            <view class="total-label">ç‰¹å¥¶ç²‰å…‹é‡</view>
            <view class="total-value">{{totalPowderWeight}}g</view>
          </view>
          <view class="total-item">
            <view class="total-label">å¤©ç„¶ç³»æ•°</view>
            <view class="total-value">{{naturalProteinCoefficient}}g/kg</view>
          </view>
          <view class="total-item">
            <view class="total-label">ç‰¹æ®Šè›‹ç™½ç³»æ•°</view>
            <view class="total-value">{{specialProteinCoefficient}}g/kg</view>
          </view>
          <view class="total-item">
            <view class="total-label">å–‚å¥¶æ¬¡æ•°</view>
            <view class="total-value">{{feedingRecords.length}}</view>
          </view>
        </view>
      </view>

      <!-- å–‚å¥¶è®°å½•åˆ—è¡¨ -->
      <view class="card">
        <view class="card-title">
          <text>å–‚å¥¶è¯¦ç»†è®°å½•</text>
          <view class="add-btn" bindtap="showAddFeedingModal">
            <image class="add-icon" src="/images/icons/add.svg" mode="aspectFit"></image>
            <text>è¡¥å……è®°å½•</text>
          </view>
        </view>
        <view wx:if="{{feedingRecords.length > 0}}">
          <view class="feeding-record" wx:for="{{feedingRecords}}" wx:key="index">
            <view class="record-content" data-index="{{index}}">
              <view class="time-info">
                <view class="time-text">{{item.formattedStartTime}}</view>
                <view class="time-text">~</view>
                <view class="time-text">{{item.formattedEndTime}}</view>
              </view>
              <view class="volume-info">
                <view class="volume-info-text">å¤©ç„¶å¥¶: {{item.naturalMilkVolume || 0}}ml</view>
                <view class="volume-info-text"> | </view>
                <view class="volume-info-text">ç‰¹å¥¶: {{item.specialMilkVolume || 0}}ml</view>
              </view>
            </view>
            <!-- æ“ä½œæŒ‰é’® -->
            <view class="action-buttons">
              <view class="action-btn edit-btn" bindtap="openEditFeedingModal" data-index="{{index}}">
                <image class="action-icon" src="/images/icons/edit.svg" mode="aspectFit"></image>
              </view>
              <view class="action-btn delete-btn" bindtap="deleteFeeding" data-index="{{index}}">
                <image class="action-icon" src="/images/icons/delete.svg" mode="aspectFit"></image>
              </view>
            </view>
          </view>
        </view>
        <view class="empty-data" wx:else>
          <view class="empty-text">æš‚æ— å–‚å¥¶è®°å½•</view>
        </view>
      </view>

      <!-- ç”¨è¯è®°å½•å¡ç‰‡ -->
      <view class="card" wx:if="{{groupedMedicationRecords.length > 0}}">
        <view class="card-title">
          <text>ç”¨è¯è®°å½•</text>
          <view class="add-btn" bindtap="showAddMedicationModal">
            <image class="add-icon" src="/images/icons/add.svg" mode="aspectFit"></image>
            <text>è¡¥å……è®°å½•</text>
          </view>
        </view>
        <view>
          <!-- æŒ‰è¯ç‰©åç§°åˆ†ç»„æ˜¾ç¤º -->
          <view class="medication-group" wx:for="{{groupedMedicationRecords}}" wx:key="medicationName" wx:for-item="group">
            <view class="medication-group-header">
              <text class="medication-group-name">{{group.medicationName}}</text>
              <text class="medication-group-count">ä»Šæ—¥{{group.totalCount}}æ¬¡</text>
            </view>
            
            <!-- è¯¥è¯ç‰©çš„æ‰€æœ‰è®°å½• -->
            <view class="medication-group-records">
              <view class="medication-record-item" wx:for="{{group.records}}" wx:key="_id" wx:for-item="record">
                <view class="record-content">
                  <view class="medication-time-dose">
                    <text class="medication-time">{{record.actualTime}}</text>
                    <text class="medication-volume">{{record.dosage}}{{record.unit}}</text>
                  </view>
                </view>
                <!-- æ“ä½œæŒ‰é’® -->
                <view class="action-buttons">
                  <view class="action-btn edit-btn" bindtap="openEditMedicationModal" data-record-id="{{record._id}}">
                    <image class="action-icon" src="/images/icons/edit.svg" mode="aspectFit"></image>
                  </view>
                  <view class="action-btn delete-btn" bindtap="deleteMedication" data-record-id="{{record._id}}">
                    <image class="action-icon" src="/images/icons/delete.svg" mode="aspectFit"></image>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- æ—¥å†é€‰æ‹©å™¨ -->
  <view class="calendar-picker" wx:if="{{showCalendarPicker}}" bindtap="hideCalendar">
    <view class="calendar-content" catchtap="preventBubble">
      <view class="calendar-header">
        <view bindtap="prevMonth">ã€ˆ</view>
        <view class="month-title">{{calendarYear}}å¹´{{calendarMonth}}æœˆ</view>
        <view bindtap="nextMonth">ã€‰</view>
      </view>
      
      <view class="weekday-header">
        <view class="weekday-item" wx:for="{{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']}}" wx:key="*this">{{item}}</view>
      </view>
      
      <view class="calendar-grid">
        <view 
          class="calendar-day {{item.isCurrentMonth ? '' : 'other-month'}} {{item.date === selectedDate ? 'active' : ''}} {{item.isToday ? 'date-today' : ''}}"
          wx:for="{{calendarDays}}"
          wx:key="date"
          bindtap="{{item.isCurrentMonth ? 'selectCalendarDay' : ''}}"
          data-date="{{item.date}}"
        >
          {{item.day}}
        </view>
      </view>
      
      <view class="calendar-footer">
        <view class="today-btn" bindtap="goToToday">ä»Šå¤©</view>
      </view>
    </view>
  </view>

  <!-- è¡¥å……å–‚å¥¶è®°å½•å¼¹çª— -->
  <view class="modal" wx:if="{{showAddFeedingModal}}" bindtap="hideAddFeedingModal">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>è¡¥å……å–‚å¥¶è®°å½•</text>
      </view>
      <view class="modal-body">
        <!-- æ—¶é—´é€‰æ‹© -->
        <view class="time-selection">
          <view class="time-picker-group">
            <text class="label">å¼€å§‹æ—¶é—´</text>
            <picker mode="time" value="{{newFeeding.startTime}}" data-field="startTime" bindchange="onNewFeedingTimeChange">
              <view class="time-picker">{{newFeeding.startTime}}</view>
            </picker>
          </view>
          
          <view class="time-picker-group">
            <text class="label">ç»“æŸæ—¶é—´</text>
            <picker mode="time" value="{{newFeeding.endTime}}" data-field="endTime" bindchange="onNewFeedingTimeChange">
              <view class="time-picker">{{newFeeding.endTime}}</view>
            </picker>
          </view>
        </view>
        
        <!-- å¤©ç„¶å¥¶é‡ -->
        <view class="input-group">
          <text class="label">å¤©ç„¶å¥¶é‡ (ml)</text>
          <input 
            type="digit" 
            value="{{newFeeding.naturalMilkVolume}}" 
            data-field="naturalMilkVolume" 
            bindinput="onNewFeedingInput"
            placeholder="è¯·è¾“å…¥å¤©ç„¶å¥¶é‡"
          />
        </view>

        <!-- æ€»å¥¶é‡ -->
        <view class="input-group">
          <text class="label">æ€»å¥¶é‡ (ml)</text>
          <input 
            type="digit" 
            value="{{newFeeding.totalVolume}}" 
            data-field="totalVolume" 
            bindinput="onNewFeedingInput"
            placeholder="è¯·è¾“å…¥æ€»å¥¶é‡"
          />
        </view>
        
        <!-- ç‰¹å¥¶é‡å±•ç¤º -->
        <view class="special-milk">
          <text class="label">ç‰¹å¥¶é‡:</text>
          <text class="value">{{newFeeding.specialMilkVolume || '0'}}ml</text>
          <text class="powder-weight">({{newFeeding.specialPowderWeight || '0'}}gå¥¶ç²‰)</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideAddFeedingModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="saveNewFeeding">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- è¡¥å……ç”¨è¯è®°å½•å¼¹çª— -->
  <view class="modal" wx:if="{{showAddMedicationModal}}" bindtap="hideAddMedicationModal">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>è¡¥å……ç”¨è¯è®°å½•</text>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="label">é€‰æ‹©è¯ç‰©</text>
          <picker 
            mode="selector" 
            range="{{medications}}" 
            range-key="name"
            bindchange="onMedicationSelect"
          >
            <view class="picker {{newMedication.name ? '' : 'placeholder'}}">
              {{newMedication.name || 'è¯·é€‰æ‹©è¯ç‰©'}}
            </view>
          </picker>
        </view>

        <view class="form-item">
          <text class="label">ç”¨è¯å‰‚é‡</text>
          <view class="dosage-input-container">
            <input 
              type="digit" 
              value="{{newMedication.dosage}}" 
              data-field="dosage" 
              bindinput="onNewMedicationInput"
              placeholder="è¯·è¾“å…¥å‰‚é‡"
              class="dosage-input"
            />
            <text class="unit-text">{{newMedication.unit}}</text>
          </view>
        </view>

        <view class="form-item">
          <text class="label">ç”¨è¯æ—¶é—´</text>
          <picker mode="time" value="{{newMedication.time}}" data-field="time" bindchange="onNewMedicationTimeChange">
            <view class="time-picker">{{newMedication.time}}</view>
          </picker>
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideAddMedicationModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="saveNewMedication">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
  <view class="confirm-modal" wx:if="{{showDeleteConfirm}}" bindtap="hideDeleteConfirm">
    <view class="confirm-modal-content" catchtap="preventBubble">
      <view class="confirm-modal-title">ç¡®è®¤åˆ é™¤</view>
      <view class="confirm-modal-message">{{deleteConfirmMessage}}</view>
      <view class="confirm-modal-footer">
        <view class="confirm-modal-btn cancel" bindtap="hideDeleteConfirm">å–æ¶ˆ</view>
        <view class="confirm-modal-btn confirm" bindtap="confirmDelete">åˆ é™¤</view>
      </view>
    </view>
  </view>

  <!-- ç¼–è¾‘å–‚å¥¶è®°å½•å¼¹çª— -->
  <view class="modal" wx:if="{{showEditFeedingModal}}" bindtap="hideEditFeedingModal">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>ç¼–è¾‘å–‚å¥¶è®°å½•</text>
      </view>
      <view class="modal-body">
        <!-- æ—¶é—´é€‰æ‹© -->
        <view class="time-selection">
          <view class="time-picker-group">
            <text class="label">å¼€å§‹æ—¶é—´</text>
            <picker mode="time" value="{{editingFeeding.formattedStartTime}}" data-field="formattedStartTime" bindchange="onEditFeedingTimeChange">
              <view class="time-picker">{{editingFeeding.formattedStartTime}}</view>
            </picker>
          </view>
          
          <view class="time-picker-group">
            <text class="label">ç»“æŸæ—¶é—´</text>
            <picker mode="time" value="{{editingFeeding.formattedEndTime}}" data-field="formattedEndTime" bindchange="onEditFeedingTimeChange">
              <view class="time-picker">{{editingFeeding.formattedEndTime}}</view>
            </picker>
          </view>
        </view>
        
        <!-- å¤©ç„¶å¥¶é‡ -->
        <view class="input-group">
          <text class="label">å¤©ç„¶å¥¶é‡ (ml)</text>
          <input 
            type="digit" 
            value="{{editingFeeding.naturalMilkVolume}}" 
            data-field="naturalMilkVolume" 
            bindinput="onEditFeedingInput"
            placeholder="è¯·è¾“å…¥å¤©ç„¶å¥¶é‡"
          />
        </view>

        <!-- æ€»å¥¶é‡ -->
        <view class="input-group">
          <text class="label">æ€»å¥¶é‡ (ml)</text>
          <input 
            type="digit" 
            value="{{editingFeeding.totalVolume || (editingFeeding.naturalMilkVolume + editingFeeding.specialMilkVolume)}}" 
            data-field="totalVolume" 
            bindinput="onEditFeedingInput"
            placeholder="è¯·è¾“å…¥æ€»å¥¶é‡"
          />
        </view>
        
        <!-- ç‰¹å¥¶é‡å±•ç¤º -->
        <view class="special-milk">
          <text class="label">ç‰¹å¥¶é‡:</text>
          <text class="value">{{editingFeeding.specialMilkVolume || '0'}}ml</text>
          <text class="powder-weight">({{editingFeeding.specialPowderWeight || '0'}}gå¥¶ç²‰)</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideEditFeedingModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="saveEditedFeeding">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- ç¼–è¾‘ç”¨è¯è®°å½•å¼¹çª— -->
  <view class="modal" wx:if="{{showEditMedicationModal}}" bindtap="hideEditMedicationModal">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>ç¼–è¾‘ç”¨è¯è®°å½•</text>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="label">è¯ç‰©åç§°</text>
          <view class="medication-name-display">{{editingMedication.medicationName}}</view>
        </view>

        <view class="form-item">
          <text class="label">ç”¨è¯å‰‚é‡</text>
          <view class="dosage-input-container">
            <input 
              type="digit" 
              value="{{editingMedication.dosage}}" 
              data-field="dosage" 
              bindinput="onEditMedicationInput"
              placeholder="è¯·è¾“å…¥å‰‚é‡"
              class="dosage-input"
            />
            <text class="unit-text">{{editingMedication.unit}}</text>
          </view>
        </view>

        <view class="form-item">
          <text class="label">ç”¨è¯æ—¶é—´</text>
                      <picker mode="time" value="{{editingMedication.actualTime}}" data-field="actualTime" bindchange="onEditMedicationTimeChange">
              <view class="time-picker">{{editingMedication.actualTime}}</view>
            </picker>
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideEditMedicationModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="saveEditedMedication">ä¿å­˜</button>
      </view>
    </view>
  </view>
</view> 