<view class="container">
  <!-- 点击空白处关闭菜单的覆盖层 -->
  <view class="menu-overlay" wx:if="{{activeFeedingMenu !== -1}}" bindtap="onTapPage"></view>

  <!-- Baby Info Section -->
  <view class="section baby-info-section">
    <view class="baby-name">{{babyName}}</view>
    <view class="baby-date">{{todayDate}}</view>
    <view class="baby-days">已出生 {{babyDays}} 天</view>
  </view>

  <!-- Weight Section -->
  <view class="section weight-section">
    <text class="section-title">今日体重 (kg)</text>
    <input type="digit" class="weight-input" value="{{weight}}" placeholder="请输入体重" bindinput="onWeightInput" />
  </view>

  <!-- Protein Calculations Section -->
  <view class="section protein-section">
    <view class="calculation-header">
      <text class="header-label">天然蛋白来源: {{proteinSourceLabel}}</text>
    </view>
    
    <!-- 营养设置引导提示 -->
    <view class="settings-guide" wx:if="{{showSettingsGuide}}">
      <view class="guide-icon">
        <image src="/images/icons/warning.svg" mode="aspectFit"></image>
      </view>
      <view class="guide-content">
        <text class="guide-title">营养参数设置不完整</text>
        <text class="guide-desc">{{settingsGuideText || '您需要先完成必要的营养参数设置才能准确计算喂养量'}}</text>
        <view class="missing-items">
          <text wx:for="{{missingSettings}}" wx:key="*this" class="missing-item">{{item}}</text>
        </view>
      </view>
      <button class="guide-btn" bindtap="navigateToNutritionSettings">去设置</button>
    </view>
    
    <view class="calculation-items" wx:if="{{!showSettingsGuide}}">
      <view class="calculation-item">
        <text class="label">当天所需天然蛋白</text>
        <text class="value">{{dailyNaturalProtein}}g</text>
      </view>
      <view class="calculation-item">
        <text class="label">当天所需{{proteinSourceLabel}}量</text>
        <text class="value">{{requiredNaturalMilk}}ml</text>
      </view>
      <!-- 奶粉情况下，显示所需奶粉量 -->
      <view class="calculation-item" wx:if="{{proteinSourceType === 'formulaMilk' && formulaPowderNeeded}}">
        <text class="label">当天所需奶粉量</text>
        <text class="value">{{formulaPowderNeeded}}g</text>
      </view>
      <view class="calculation-item">
        <text class="label">当天已喂{{proteinSourceLabel}}总量</text>
        <text class="value">{{totalNaturalMilkFed}}ml</text>
      </view>
      <view class="calculation-item">
        <text class="label">当天剩余{{proteinSourceLabel}}量</text>
        <text class="value">{{remainingNaturalMilk}}ml</text>
      </view>
    </view>
  </view>

  <!-- Current Feeding Section -->
  <view class="section feeding-section">
    <!-- 标题栏带有快捷记录按钮 -->
    <view class="section-header">
      <text class="section-title">喂奶</text>
      <view class="quick-record-btn" bindtap="showQuickInputModal">
        <text>快捷记录</text>
      </view>
    </view>
    
    <!-- 未开始喂奶状态：先输入奶量 -->
    <view class="feeding-inputs" wx:if="{{!currentFeeding.startTime}}">
      <!-- 天然奶量 -->
      <view class="input-group">
        <text class="label">{{proteinSourceLabel}}量</text>
        <view class="volume-control">
          <button class="volume-btn decrease" catchtap="decreaseVolume" data-field="naturalMilkVolume">−</button>
          <input type="digit" class="volume-input" value="{{currentFeeding.naturalMilkVolume}}" 
                data-field="naturalMilkVolume" bindinput="onFeedingInput" />
          <button class="volume-btn increase" catchtap="increaseVolume" data-field="naturalMilkVolume">+</button>
          <text class="volume-unit">ml</text>
        </view>
      </view>
      
      <!-- 普通奶粉模式下显示奶粉克重 -->
      <view class="input-group" wx:if="{{proteinSourceType === 'formulaMilk'}}">
        <text class="label">奶粉克重</text>
        <view class="volume-control">
          <text class="volume-input lh-80">{{currentFeeding.formulaPowderWeight || '0'}}</text>
          <text class="volume-unit">g</text>
        </view>
      </view>
      
      <!-- 特奶量 -->
      <view class="input-group">
        <text class="label">特奶量</text>
        <view class="volume-control">
          <button class="volume-btn decrease" catchtap="decreaseVolume" data-field="specialMilkVolume">−</button>
          <input type="digit" class="volume-input" value="{{currentFeeding.specialMilkVolume}}" 
                data-field="specialMilkVolume" bindinput="onFeedingInput" />
          <button class="volume-btn increase" catchtap="increaseVolume" data-field="specialMilkVolume">+</button>
          <text class="volume-unit">ml</text>
        </view>
      </view>
      
      <!-- 计算结果显示 -->
      <view class="special-milk">
        <view class="special-milk-item">
          <text class="label">总奶量:</text>
          <text class="value">{{currentFeeding.totalVolume || '0'}}ml</text>
        </view>
        <view class="special-milk-item">
          <text class="label">特奶粉:</text>
          <text class="value">{{currentFeeding.specialMilkPowder || '0'}}g</text>
        </view>
      </view>
      
      <!-- 按钮区域 -->
      <view class="feeding-buttons">
        <button class="start-feeding-btn" bindtap="startFeeding">
          <text class="btn-text">立即开始</text>
        </button>
      </view>
    </view>
    
    <!-- 正在喂奶状态：显示记录中 -->
    <view class="feeding-active" wx:if="{{currentFeeding.startTime && !currentFeeding.endTime}}">
      <view class="feeding-status">
        <view class="status-row">
          <text class="status-label">开始时间:</text>
          <text class="status-value">{{currentFeeding.startTime}}</text>
        </view>
        <view class="status-row">
          <text class="status-label">状态:</text>
          <text class="status-value highlight">记录中...</text>
        </view>
      </view>
      
      <!-- 显示喂奶数据 -->
      <view class="feeding-data">
        <view class="data-row">
          <text class="data-label">{{proteinSourceLabel}}量:</text>
          <text class="data-value">{{currentFeeding.naturalMilkVolume}}ml</text>
        </view>
        <!-- 普通奶粉情况下显示奶粉重量 -->
        <view class="data-row" wx:if="{{proteinSourceType === 'formulaMilk'}}">
          <text class="data-label">奶粉重量:</text>
          <text class="data-value">{{currentFeeding.formulaPowderWeight || '0'}}g</text>
        </view>
        <view class="data-row">
          <text class="data-label">特奶量:</text>
          <text class="data-value">{{currentFeeding.specialMilkVolume}}ml</text>
        </view>
        <view class="data-row">
          <text class="data-label">特奶粉:</text>
          <text class="data-value">{{currentFeeding.specialMilkPowder}}g</text>
        </view>
        <view class="data-row">
          <text class="data-label">总量:</text>
          <text class="data-value">{{currentFeeding.totalVolume}}ml</text>
        </view>
      </view>
      
      <!-- 按钮区域 -->
      <view class="feeding-buttons">
        <!-- 撤销按钮 -->
        <button class="cancel-feeding-btn" bindtap="cancelFeeding">
          <text class="btn-text-secondary">撤销</text>
        </button>
        
        <!-- 结束按钮 -->
        <button class="end-feeding-btn" bindtap="endFeeding">
          <text class="btn-text">立即结束</text>
        </button>
      </view>
    </view>
  </view>

  <!-- Medication Section -->
  <view class="section medication-section">
    <text class="section-title">喂药</text>
    <view class="medication-grid">
      <!-- 使用数据库加载的药物列表 -->
      <view class="medication-item {{hasTakenMedication(item._id) ? 'active' : ''}}" 
            wx:for="{{medicationsList}}" wx:key="_id"
            data-medication="{{item._id}}" bindtap="openMedicationModal">
        <text>{{item.name}}</text>
        <text class="volume">{{item.dosage}}{{item.unit}}</text>
      </view>
      
      <!-- 如果没有药物，显示添加提示 -->
      <view class="no-medications" wx:if="{{!medicationsList || medicationsList.length === 0}}">
        <text>请先在"我的-药物设置"中添加药物</text>
      </view>
    </view>
  </view>

  <!-- Bowel Movement Section -->
  <view class="section bowel-section">
    <view class="section-header">
      <text class="section-title">排便记录</text>
      <view class="bowel-stats">
        <text class="stats-text">今日 {{bowelStats.totalCount}} 次</text>
      </view>
    </view>
    
    <view class="bowel-grid">
      <!-- 大便按钮 -->
      <view class="bowel-item stool" data-type="stool" bindtap="showBowelRecordModal">
        <view class="bowel-icon">💩</view>
        <text class="bowel-label">大便</text>
        <text class="bowel-count">{{bowelStats.stoolCount}}次</text>
      </view>
      
      <!-- 小便按钮 -->
      <view class="bowel-item urine" data-type="urine" bindtap="showBowelRecordModal">
        <view class="bowel-icon">💧</view>
        <text class="bowel-label">小便</text>
        <text class="bowel-count">{{bowelStats.urineCount}}次</text>
      </view>
      
      <!-- 混合按钮 -->
      <view class="bowel-item mixed" data-type="mixed" bindtap="showBowelRecordModal">
        <view class="bowel-icon">🚽</view>
        <text class="bowel-label">混合</text>
        <text class="bowel-count">{{bowelStats.mixedCount}}次</text>
      </view>
    </view>
  </view>

  <!-- Records Section -->
  <view class="section records-section">
    <text class="section-title">今日数据记录</text>
    
    <!-- 选项卡标题 -->
    <view class="tabs">
      <view class="tab {{activeTab === 'feeding' ? 'active' : ''}}" bindtap="switchTab" data-tab="feeding">
        <text>喂奶记录</text>
      </view>
      <view class="tab {{activeTab === 'medication' ? 'active' : ''}}" bindtap="switchTab" data-tab="medication">
        <text>用药记录</text>
      </view>
      <view class="tab {{activeTab === 'bowel' ? 'active' : ''}}" bindtap="switchTab" data-tab="bowel">
        <text>排便记录</text>
      </view>
    </view>
    
    <!-- 喂奶记录 -->
    <view class="tab-content" hidden="{{activeTab !== 'feeding'}}">
      <view class="records-list">
        <view class="record-item" wx:for="{{feedings}}" wx:key="index">
          <view class="record-content" bindtap="openEditModal" data-index="{{index}}">
            <view class="record-time">{{item.startTime}} – {{item.endTime}}</view>
            <view class="record-details">
              <view class="record-detail-item">
                <text class="detail-label">{{proteinSourceLabel}}:</text>
                <text class="detail-value">{{item.naturalMilkVolume}}ml</text>
              </view>
              <!-- 普通奶粉情况下显示奶粉重量 -->
              <view class="record-detail-item" wx:if="{{proteinSourceType === 'formulaMilk'}}">
                <text class="detail-label">奶粉:</text>
                <text class="detail-value">{{item.formulaPowderWeight || '0'}}g</text>
              </view>
              <view class="record-detail-item">
                <text class="detail-label">特奶:</text>
                <text class="detail-value">{{item.specialMilkVolume}}ml</text>
              </view>
              <view class="record-detail-item">
                <text class="detail-label">特奶粉:</text>
                <text class="detail-value">{{item.specialMilkPowder || '0'}}g</text>
              </view>
              <view class="record-detail-item">
                <text class="detail-label">总量:</text>
                <text class="detail-value">{{item.totalVolume}}ml</text>
              </view>
            </view>
          </view>
          <!-- 三点菜单按钮 -->
          <view class="menu-btn" catchtap="toggleFeedingMenu" data-index="{{index}}">
            <view class="dot-menu">
              <view class="dot"></view>
              <view class="dot"></view>
              <view class="dot"></view>
            </view>
          </view>
          
          <!-- 菜单弹出选项 -->
          <view class="menu-options {{activeFeedingMenu === index ? 'show' : ''}}" wx:if="{{activeFeedingMenu === index}}">
            <view class="menu-option" catchtap="openEditModal" data-index="{{index}}" data-action="edit">
              <text>编辑</text>
            </view>
            <view class="menu-option delete" catchtap="deleteFeeding" data-index="{{index}}" data-action="delete">
              <text>删除</text>
            </view>
          </view>
        </view>
        <view class="empty-record" wx:if="{{feedings.length === 0}}">
          <text>暂无喂奶记录</text>
        </view>
      </view>
    </view>

    <!-- 药物记录 -->
    <view class="tab-content" hidden="{{activeTab !== 'medication'}}">
      <view class="medication-records">
        <!-- 按药物名称分组显示 -->
        <view class="medication-group" wx:for="{{groupedMedicationRecords}}" wx:key="medicationName" wx:for-item="group">
          <view class="medication-group-header">
            <text class="medication-group-name">{{group.medicationName}}</text>
            <text class="medication-group-count">今日{{group.totalCount}}次</text>
          </view>
          
          <!-- 该药物的所有记录 -->
          <view class="medication-group-records">
            <view class="medication-record-item" wx:for="{{group.records}}" wx:key="originalIndex" wx:for-item="record">
              <view class="record-content" data-index="{{record.originalIndex}}">
                <view class="medication-time-dose">
                  <text class="medication-time">{{record.actualTime}}</text>
                  <text class="medication-volume">{{record.dosage}}{{record.unit}}</text>
                </view>
              </view>
              <!-- 操作按钮 -->
              <view class="action-buttons">
                <view class="action-btn edit-btn" bindtap="openMedicationRecordModal" data-medication-id="{{record._id}}" data-action="view">
                  <image class="action-icon" src="/images/icons/edit.svg" mode="aspectFit"></image>
                </view>
                <view class="action-btn delete-btn" bindtap="deleteMedication" data-medication-id="{{record._id}}" data-action="delete">
                  <image class="action-icon" src="/images/icons/delete.svg" mode="aspectFit"></image>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <view class="empty-record" wx:if="{{medicationRecords.length === 0}}">
          <text>暂无用药记录</text>
        </view>
      </view>
    </view>

    <!-- 排便记录 -->
    <view class="tab-content" hidden="{{activeTab !== 'bowel'}}">
      <view class="bowel-records">
        <!-- 按类型分组显示 -->
        <view class="bowel-group" wx:for="{{bowelRecords}}" wx:key="type" wx:for-item="group">
          <view class="bowel-group-header">
            <text class="bowel-group-title">{{group.typeText}}</text>
            <text class="bowel-group-count">{{group.count}}次</text>
          </view>
          
          <!-- 该类型的所有记录 -->
          <view class="bowel-group-records">
            <view class="bowel-record-item" wx:for="{{group.records}}" wx:key="_id" wx:for-item="record" wx:for-index="recordIndex">
              <view class="record-content">
                <view class="bowel-time-type">
                  <text class="bowel-time">{{record.timeString}}</text>
                </view>
                <!-- 大便详细信息 -->
                <view class="bowel-details" wx:if="{{record.type === 'stool' || record.type === 'mixed'}}">
                  <text class="bowel-detail" wx:if="{{record.consistencyText}}">{{record.consistencyText}}</text>
                  <text class="bowel-detail" wx:if="{{record.colorText}}">{{record.colorText}}</text>
                  <text class="bowel-detail" wx:if="{{record.amountText}}">{{record.amountText}}</text>
                </view>
                <!-- 备注 -->
                <view class="bowel-notes" wx:if="{{record.notes}}">
                  <text class="notes-text">{{record.notes}}</text>
                </view>
              </view>
              <!-- 操作按钮 -->
              <view class="action-buttons">
                <view class="action-btn edit-btn" catchtap="editBowelRecord" data-group-index="{{index}}" data-record-index="{{recordIndex}}">
                  <image class="action-icon" src="/images/icons/edit.svg" mode="aspectFit"></image>
                </view>
                <view class="action-btn delete-btn" catchtap="deleteBowelRecord" data-record-id="{{record._id}}">
                  <image class="action-icon" src="/images/icons/delete.svg" mode="aspectFit"></image>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <view class="empty-record" wx:if="{{bowelRecords.length === 0}}">
          <text>暂无排便记录</text>
        </view>
      </view>
    </view>
  </view>

  <!-- Medication Modal -->
  <view class="modal" wx:if="{{modals.medication}}" bindtap="closeMedicationModal" catchtouchmove="preventBubble">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>记录用药</text>
      </view>
      <view class="modal-body">
        <view class="modal-info-row">
          <text class="modal-label">药物名称:</text>
          <text class="modal-value">{{selectedMedicationInfo.name}}</text>
        </view>
        <view class="modal-info-row">
          <text class="modal-label">药物剂量:</text>
          <view class="dosage-input-container">
            <input type="digit" class="dosage-input" value="{{currentModalDosage}}" bindinput="onMedicationDosageChange" placeholder="请输入药物剂量" />
            <text class="dosage-unit">{{selectedMedicationInfo.unit}}</text>
          </view>
        </view>
        <view class="modal-info-row" wx:if="{{selectedMedicationInfo.frequency}}">
          <text class="modal-label">服用频率:</text>
          <text class="modal-value">{{selectedMedicationInfo.frequency}}</text>
        </view>
        <view class="modal-info-row">
          <text class="modal-label">服用时间:</text>
          <picker mode="time" value="{{currentModalTime}}" start="00:00" end="23:59" bindchange="onMedicationTimeChange">
            <view class="modal-time-picker">{{currentModalTime}} <text class="edit-icon">✎</text></view>
          </picker>
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeMedicationModal">取消</button>
        <button class="modal-btn confirm" bindtap="recordMedication">确认</button>
      </view>
    </view>
  </view>
  
  <!-- 编辑记录弹窗 -->
  <view class="modal" wx:if="{{modals.edit}}" bindtap="closeEditModal" catchtouchmove="preventBubble">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>编辑喂奶记录</text>
      </view>
      <view class="modal-body">
        <!-- 时间选择 -->
        <view class="time-selection">
          <view class="time-picker-group">
            <text class="label">开始时间</text>
            <picker mode="time" value="{{editingFeeding.startTime}}" bindchange="onEditFeedingInput" data-field="startTime">
              <view class="time-picker">{{editingFeeding.startTime}}</view>
            </picker>
          </view>
          
          <view class="time-picker-group">
            <text class="label">结束时间</text>
            <picker mode="time" value="{{editingFeeding.endTime}}" bindchange="onEditFeedingInput" data-field="endTime">
              <view class="time-picker">{{editingFeeding.endTime}}</view>
            </picker>
          </view>
        </view>
        
        <!-- 天然奶量 -->
        <view class="input-group">
          <text class="label">{{proteinSourceLabel}}量</text>
          <view class="volume-control">
            <input type="digit" class="volume-input" value="{{editingFeeding.naturalMilkVolume}}" 
                  data-field="naturalMilkVolume" bindinput="onEditFeedingInput" />
            <text class="volume-unit">ml</text>
          </view>
        </view>
        
        <!-- 普通奶粉情况下显示奶粉重量 -->
        <view class="input-group" wx:if="{{proteinSourceType === 'formulaMilk'}}">
          <text class="label">奶粉重量</text>
          <view class="volume-control">
            <text class="volume-value">{{editingFeeding.formulaPowderWeight || '0'}}g</text>
          </view>
        </view>
        
        <!-- 特奶量 -->
        <view class="input-group">
          <text class="label">特奶量</text>
          <view class="volume-control">
            <input type="digit" class="volume-input" value="{{editingFeeding.specialMilkVolume}}" 
                  data-field="specialMilkVolume" bindinput="onEditFeedingInput" />
            <text class="volume-unit">ml</text>
          </view>
        </view>
        
        <!-- 计算结果 -->
        <view class="special-milk">
          <view class="special-milk-item">
            <text class="label">总奶量:</text>
            <text class="value">{{editingFeeding.totalVolume || '0'}}ml</text>
          </view>
          <view class="special-milk-item">
            <text class="label">特奶粉:</text>
            <text class="value">{{editingFeeding.specialMilkPowder || '0'}}g</text>
          </view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeEditModal">取消</button>
        <button class="modal-btn confirm" bindtap="saveEditedFeeding">保存</button>
      </view>
    </view>
  </view>
  
  <!-- 药物记录详情弹窗 -->
  <view class="modal" wx:if="{{modals.medicationRecord}}" bindtap="closeMedicationRecordModal" catchtouchmove="preventBubble">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>药物记录详情</text>
      </view>
      <view class="modal-body">
        <view class="modal-info-row">
          <text class="modal-label">药物名称:</text>
          <text class="modal-value">{{selectedMedicationRecord.medicationName}}</text>
        </view>
        <view class="modal-info-row">
          <text class="modal-label">药物剂量:</text>
          <view class="dosage-input-container">
            <input type="digit" class="dosage-input" value="{{selectedMedicationRecord.dosage}}" bindinput="onMedicationRecordDosageChange" />
            <text class="dosage-unit">{{selectedMedicationRecord.unit}}</text>
          </view>
        </view>
        <view class="modal-info-row">
          <text class="modal-label">服用时间:</text>
          <picker mode="time" value="{{selectedMedicationRecord.actualTime}}" start="00:00" end="23:59" bindchange="onMedicationRecordTimeChange">
            <view class="modal-time-picker">{{selectedMedicationRecord.actualTime}} <text class="edit-icon">✎</text></view>
          </picker>
        </view>
        <view class="modal-info-row" wx:if="{{selectedMedicationRecord.frequency}}">
          <text class="modal-label">服用频率:</text>
          <text class="modal-value">{{selectedMedicationRecord.frequency}}</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeMedicationRecordModal">取消</button>
        <button class="modal-btn confirm" bindtap="saveMedicationRecordChanges">保存</button>
      </view>
    </view>
  </view>
  
  <!-- 快捷记录弹窗 -->
  <view class="modal" wx:if="{{modals.quickInput}}" bindtap="hideQuickInputModal" catchtouchmove="preventBubble">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>快捷记录</text>
      </view>
      <view class="modal-body">
        <!-- 时间选择 -->
        <view class="time-selection">
          <view class="time-picker-group">
            <text class="label">开始时间</text>
            <picker mode="time" value="{{quickFeedingData.startTime}}" bindchange="onQuickStartTimeChange">
              <view class="time-picker">{{quickFeedingData.startTime || '选择时间'}}</view>
            </picker>
          </view>
          
          <view class="time-picker-group">
            <text class="label">结束时间</text>
            <picker mode="time" value="{{quickFeedingData.endTime}}" bindchange="onQuickEndTimeChange">
              <view class="time-picker">{{quickFeedingData.endTime || '选择时间'}}</view>
            </picker>
          </view>
        </view>
        
        <!-- 天然奶量 -->
        <view class="input-group">
          <text class="label">{{proteinSourceLabel}}量</text>
          <view class="volume-control">
            <button class="volume-btn decrease" catchtap="decreaseVolume" data-field="quickNaturalMilk">−</button>
            <input type="digit" class="volume-input" value="{{quickFeedingData.naturalMilkVolume}}" 
                  data-field="quickNaturalMilk" bindinput="onQuickFeedingInput" />
            <button class="volume-btn increase" catchtap="increaseVolume" data-field="quickNaturalMilk">+</button>
            <text class="volume-unit">ml</text>
          </view>
        </view>
        
        <!-- 普通奶粉情况下显示奶粉重量 -->
        <view class="input-group" wx:if="{{proteinSourceType === 'formulaMilk'}}">
          <text class="label">奶粉重量</text>
          <view class="volume-control">
            <text class="volume-value">{{quickFeedingData.formulaPowderWeight || '0'}}g</text>
          </view>
        </view>
        
        <!-- 特奶量 -->
        <view class="input-group">
          <text class="label">特奶量</text>
          <view class="volume-control">
            <button class="volume-btn decrease" catchtap="decreaseVolume" data-field="quickSpecialMilk">−</button>
            <input type="digit" class="volume-input" value="{{quickFeedingData.specialMilkVolume}}" 
                  data-field="quickSpecialMilk" bindinput="onQuickFeedingInput" />
            <button class="volume-btn increase" catchtap="increaseVolume" data-field="quickSpecialMilk">+</button>
            <text class="volume-unit">ml</text>
          </view>
        </view>
        
        <!-- 计算结果展示 -->
        <view class="special-milk">
          <view class="special-milk-item">
            <text class="label">总奶量:</text>
            <text class="value">{{quickFeedingData.totalVolume || '0'}}ml</text>
          </view>
          <view class="special-milk-item">
            <text class="label">特奶粉:</text>
            <text class="value">{{quickFeedingData.specialMilkPowder || '0'}}g</text>
          </view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideQuickInputModal">取消</button>
        <button class="modal-btn confirm" bindtap="saveQuickFeeding">确认记录</button>
      </view>
    </view>
  </view>

  <!-- 排便记录弹窗 -->
  <view class="modal bowel-record-modal" wx:if="{{modals.bowelRecord}}" bindtap="hideBowelRecordModal" catchtouchmove="preventBubble">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>记录排便</text>
      </view>
      <scroll-view class="modal-body" scroll-y="true" enhanced="true" show-scrollbar="false">
        <!-- 时间选择 -->
        <view class="modal-info-row">
          <text class="modal-label">时间:</text>
          <picker mode="time" value="{{newBowelRecord.time}}" start="00:00" end="23:59" bindchange="onBowelTimeChange">
            <view class="modal-time-picker">{{newBowelRecord.time}} <text class="edit-icon">✎</text></view>
          </picker>
        </view>
        
        <!-- 类型选择 -->
        <view class="modal-info-row">
          <text class="modal-label">类型:</text>
          <view class="bowel-type-selector">
            <view class="type-option {{newBowelRecord.type === 'stool' ? 'selected' : ''}}" 
                  data-field="type" data-value="stool" bindtap="onBowelRecordSelect">
              <text>大便</text>
            </view>
            <view class="type-option {{newBowelRecord.type === 'urine' ? 'selected' : ''}}" 
                  data-field="type" data-value="urine" bindtap="onBowelRecordSelect">
              <text>小便</text>
            </view>
            <view class="type-option {{newBowelRecord.type === 'mixed' ? 'selected' : ''}}" 
                  data-field="type" data-value="mixed" bindtap="onBowelRecordSelect">
              <text>混合</text>
            </view>
          </view>
        </view>
        
        <!-- 大便详细信息（仅在大便或混合时显示） -->
        <view class="bowel-detail-section" wx:if="{{newBowelRecord.type === 'stool' || newBowelRecord.type === 'mixed'}}">
          <!-- 性状 -->
          <view class="modal-info-row">
            <text class="modal-label">性状:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{newBowelRecord.consistency === 'liquid' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="liquid" bindtap="onBowelRecordSelect">
                <text>水样</text>
              </view>
              <view class="option-item {{newBowelRecord.consistency === 'loose' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="loose" bindtap="onBowelRecordSelect">
                <text>稀便</text>
              </view>
              <view class="option-item {{newBowelRecord.consistency === 'soft' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="soft" bindtap="onBowelRecordSelect">
                <text>糊状</text>
              </view>
              <view class="option-item {{newBowelRecord.consistency === 'normal' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="normal" bindtap="onBowelRecordSelect">
                <text>正常</text>
              </view>
              <view class="option-item {{newBowelRecord.consistency === 'hard' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="hard" bindtap="onBowelRecordSelect">
                <text>干硬</text>
              </view>
            </view>
          </view>
          
          <!-- 颜色 -->
          <view class="modal-info-row">
            <text class="modal-label">颜色:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{newBowelRecord.color === 'yellow' ? 'selected' : ''}}" 
                    data-field="color" data-value="yellow" bindtap="onBowelRecordSelect">
                <text>黄色</text>
              </view>
              <view class="option-item {{newBowelRecord.color === 'green' ? 'selected' : ''}}" 
                    data-field="color" data-value="green" bindtap="onBowelRecordSelect">
                <text>绿色</text>
              </view>
              <view class="option-item {{newBowelRecord.color === 'brown' ? 'selected' : ''}}" 
                    data-field="color" data-value="brown" bindtap="onBowelRecordSelect">
                <text>褐色</text>
              </view>
              <view class="option-item {{newBowelRecord.color === 'white' ? 'selected' : ''}}" 
                    data-field="color" data-value="white" bindtap="onBowelRecordSelect">
                <text>白色</text>
              </view>
              <view class="option-item {{newBowelRecord.color === 'red' ? 'selected' : ''}}" 
                    data-field="color" data-value="red" bindtap="onBowelRecordSelect">
                <text>红色</text>
              </view>
              <view class="option-item {{newBowelRecord.color === 'black' ? 'selected' : ''}}" 
                    data-field="color" data-value="black" bindtap="onBowelRecordSelect">
                <text>黑色</text>
              </view>
            </view>
          </view>
          
          <!-- 气味 -->
          <view class="modal-info-row">
            <text class="modal-label">气味:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{newBowelRecord.smell === 'normal' ? 'selected' : ''}}" 
                    data-field="smell" data-value="normal" bindtap="onBowelRecordSelect">
                <text>正常</text>
              </view>
              <view class="option-item {{newBowelRecord.smell === 'sour' ? 'selected' : ''}}" 
                    data-field="smell" data-value="sour" bindtap="onBowelRecordSelect">
                <text>酸臭</text>
              </view>
              <view class="option-item {{newBowelRecord.smell === 'fishy' ? 'selected' : ''}}" 
                    data-field="smell" data-value="fishy" bindtap="onBowelRecordSelect">
                <text>腥臭</text>
              </view>
              <view class="option-item {{newBowelRecord.smell === 'odorless' ? 'selected' : ''}}" 
                    data-field="smell" data-value="odorless" bindtap="onBowelRecordSelect">
                <text>无味</text>
              </view>
            </view>
          </view>
          
          <!-- 分量 -->
          <view class="modal-info-row">
            <text class="modal-label">分量:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{newBowelRecord.amount === 'small' ? 'selected' : ''}}" 
                    data-field="amount" data-value="small" bindtap="onBowelRecordSelect">
                <text>少量</text>
              </view>
              <view class="option-item {{newBowelRecord.amount === 'medium' ? 'selected' : ''}}" 
                    data-field="amount" data-value="medium" bindtap="onBowelRecordSelect">
                <text>适量</text>
              </view>
              <view class="option-item {{newBowelRecord.amount === 'large' ? 'selected' : ''}}" 
                    data-field="amount" data-value="large" bindtap="onBowelRecordSelect">
                <text>大量</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- 备注 -->
        <view class="modal-info-row">
          <text class="modal-label">备注:</text>
          <textarea class="notes-input" placeholder="可选，记录特殊情况" 
                    value="{{newBowelRecord.notes}}" data-field="notes" bindinput="onBowelRecordInput"></textarea>
        </view>
      </scroll-view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideBowelRecordModal">取消</button>
        <button class="modal-btn confirm" bindtap="saveBowelRecord">保存</button>
      </view>
    </view>
  </view>

  <!-- 编辑排便记录弹窗 -->
  <view class="modal bowel-edit-modal" wx:if="{{modals.bowelEdit}}" bindtap="hideBowelEditModal" catchtouchmove="preventBubble">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>编辑排便记录</text>
      </view>
      <scroll-view class="modal-body" scroll-y="true" enhanced="true" show-scrollbar="false">
        <!-- 时间选择 -->
        <view class="modal-info-row">
          <text class="modal-label">时间:</text>
          <picker mode="time" value="{{editingBowelRecord.timeString}}" start="00:00" end="23:59" bindchange="onEditBowelTimeChange">
            <view class="modal-time-picker">{{editingBowelRecord.timeString}} <text class="edit-icon">✎</text></view>
          </picker>
        </view>
        
        <!-- 类型选择 -->
        <view class="modal-info-row">
          <text class="modal-label">类型:</text>
          <view class="bowel-type-selector">
            <view class="type-option {{editingBowelRecord.type === 'stool' ? 'selected' : ''}}" 
                  data-field="type" data-value="stool" bindtap="onEditBowelRecordSelect">
              <text>大便</text>
            </view>
            <view class="type-option {{editingBowelRecord.type === 'urine' ? 'selected' : ''}}" 
                  data-field="type" data-value="urine" bindtap="onEditBowelRecordSelect">
              <text>小便</text>
            </view>
            <view class="type-option {{editingBowelRecord.type === 'mixed' ? 'selected' : ''}}" 
                  data-field="type" data-value="mixed" bindtap="onEditBowelRecordSelect">
              <text>混合</text>
            </view>
          </view>
        </view>
        
        <!-- 大便详细信息（仅在大便或混合时显示） -->
        <view class="bowel-detail-section" wx:if="{{editingBowelRecord.type === 'stool' || editingBowelRecord.type === 'mixed'}}">
          <!-- 性状 -->
          <view class="modal-info-row">
            <text class="modal-label">性状:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{editingBowelRecord.consistency === 'liquid' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="liquid" bindtap="onEditBowelRecordSelect">
                <text>水样</text>
              </view>
              <view class="option-item {{editingBowelRecord.consistency === 'loose' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="loose" bindtap="onEditBowelRecordSelect">
                <text>稀便</text>
              </view>
              <view class="option-item {{editingBowelRecord.consistency === 'soft' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="soft" bindtap="onEditBowelRecordSelect">
                <text>糊状</text>
              </view>
              <view class="option-item {{editingBowelRecord.consistency === 'normal' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="normal" bindtap="onEditBowelRecordSelect">
                <text>正常</text>
              </view>
              <view class="option-item {{editingBowelRecord.consistency === 'hard' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="hard" bindtap="onEditBowelRecordSelect">
                <text>干硬</text>
              </view>
            </view>
          </view>
          
          <!-- 颜色 -->
          <view class="modal-info-row">
            <text class="modal-label">颜色:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{editingBowelRecord.color === 'yellow' ? 'selected' : ''}}" 
                    data-field="color" data-value="yellow" bindtap="onEditBowelRecordSelect">
                <text>黄色</text>
              </view>
              <view class="option-item {{editingBowelRecord.color === 'green' ? 'selected' : ''}}" 
                    data-field="color" data-value="green" bindtap="onEditBowelRecordSelect">
                <text>绿色</text>
              </view>
              <view class="option-item {{editingBowelRecord.color === 'brown' ? 'selected' : ''}}" 
                    data-field="color" data-value="brown" bindtap="onEditBowelRecordSelect">
                <text>褐色</text>
              </view>
              <view class="option-item {{editingBowelRecord.color === 'white' ? 'selected' : ''}}" 
                    data-field="color" data-value="white" bindtap="onEditBowelRecordSelect">
                <text>白色</text>
              </view>
              <view class="option-item {{editingBowelRecord.color === 'red' ? 'selected' : ''}}" 
                    data-field="color" data-value="red" bindtap="onEditBowelRecordSelect">
                <text>红色</text>
              </view>
              <view class="option-item {{editingBowelRecord.color === 'black' ? 'selected' : ''}}" 
                    data-field="color" data-value="black" bindtap="onEditBowelRecordSelect">
                <text>黑色</text>
              </view>
            </view>
          </view>
          
          <!-- 气味 -->
          <view class="modal-info-row">
            <text class="modal-label">气味:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{editingBowelRecord.smell === 'normal' ? 'selected' : ''}}" 
                    data-field="smell" data-value="normal" bindtap="onEditBowelRecordSelect">
                <text>正常</text>
              </view>
              <view class="option-item {{editingBowelRecord.smell === 'sour' ? 'selected' : ''}}" 
                    data-field="smell" data-value="sour" bindtap="onEditBowelRecordSelect">
                <text>酸臭</text>
              </view>
              <view class="option-item {{editingBowelRecord.smell === 'fishy' ? 'selected' : ''}}" 
                    data-field="smell" data-value="fishy" bindtap="onEditBowelRecordSelect">
                <text>腥臭</text>
              </view>
              <view class="option-item {{editingBowelRecord.smell === 'odorless' ? 'selected' : ''}}" 
                    data-field="smell" data-value="odorless" bindtap="onEditBowelRecordSelect">
                <text>无味</text>
              </view>
            </view>
          </view>
          
          <!-- 分量 -->
          <view class="modal-info-row">
            <text class="modal-label">分量:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{editingBowelRecord.amount === 'small' ? 'selected' : ''}}" 
                    data-field="amount" data-value="small" bindtap="onEditBowelRecordSelect">
                <text>少量</text>
              </view>
              <view class="option-item {{editingBowelRecord.amount === 'medium' ? 'selected' : ''}}" 
                    data-field="amount" data-value="medium" bindtap="onEditBowelRecordSelect">
                <text>适量</text>
              </view>
              <view class="option-item {{editingBowelRecord.amount === 'large' ? 'selected' : ''}}" 
                    data-field="amount" data-value="large" bindtap="onEditBowelRecordSelect">
                <text>大量</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- 备注 -->
        <view class="modal-info-row">
          <text class="modal-label">备注:</text>
          <textarea class="notes-input" placeholder="可选，记录特殊情况" 
                    value="{{editingBowelRecord.notes}}" data-field="notes" bindinput="onEditBowelRecordInput"></textarea>
        </view>
      </scroll-view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideBowelEditModal">取消</button>
        <button class="modal-btn confirm" bindtap="saveEditedBowelRecord">保存</button>
      </view>
    </view>
  </view>
</view> 