<view class="container">
  <!-- ç‚¹å‡»ç©ºç™½å¤„å…³é—­èœå•çš„è¦†ç›–å±‚ -->
  <view class="menu-overlay" wx:if="{{activeFeedingMenu !== -1 || activeFoodMenu !== -1}}" bindtap="onTapPage"></view>

  <!-- Baby Info Section -->
  <view class="section baby-info-section">
    <view class="baby-name">{{babyName}}</view>
    <view class="baby-date">{{todayDate}}</view>
    <view class="baby-days">å·²å‡ºç”Ÿ {{babyDays}} å¤©</view>
  </view>

  <!-- Weight Section -->
  <view class="section weight-section">
    <text class="section-title">ä»Šæ—¥ä½“é‡ (kg)</text>
    <input type="digit" class="weight-input" value="{{weight}}" placeholder="è¯·è¾“å…¥ä½“é‡" bindinput="onWeightInput" />
  </view>

  <view class="section weight-section">
    <text class="section-title">ç›®æ ‡ç³»æ•° (g/kg/d)</text>
    <view class="coefficient-wrapper">
      <view class="coefficient-item">
        <text class="coefficient-label">å¤©ç„¶è›‹ç™½ç³»æ•°</text>
        <view class="coefficient-input-wrapper">
          <input type="digit" class="coefficient-input" value="{{naturalProteinCoefficientInput}}" placeholder="è¯·è¾“å…¥å¤©ç„¶è›‹ç™½ç³»æ•°" bindinput="onNaturalCoefficientInput" />
          <text class="coefficient-unit">g/kg/d</text>
        </view>
      </view>
      <view class="coefficient-item">
        <text class="coefficient-label">ç‰¹æ®Šè›‹ç™½ç³»æ•°</text>
        <view class="coefficient-input-wrapper">
          <input type="digit" class="coefficient-input" value="{{specialProteinCoefficientInput}}" placeholder="è¯·è¾“å…¥ç‰¹æ®Šè›‹ç™½ç³»æ•°" bindinput="onSpecialCoefficientInput" />
          <text class="coefficient-unit">g/kg/d</text>
        </view>
      </view>
    </view>
  </view>

  <!-- Current Feeding Section -->
  <view class="section feeding-section">
    <!-- æ ‡é¢˜æ å¸¦æœ‰å¿«æ·è®°å½•æŒ‰é’® -->
    <view class="section-header">
      <text class="section-title">å–‚å…»</text>
      <view class="quick-actions">
        <view class="quick-record-btn" bindtap="showQuickInputModal">
          <text>æ·»åŠ å–‚å¥¶</text>
        </view>
        <view class="quick-record-btn secondary" bindtap="showFoodIntakeExperimentModal">
          <text>æ·»åŠ é£Ÿç‰©</text>
        </view>
        <view class="quick-record-btn secondary" bindtap="openMedicationModal">
          <text>è®°å½•ç”¨è¯</text>
        </view>
      </view>
    </view>
  </view>

  <!-- Intake Summary Section -->
  <view class="section intake-section">
    <view class="section-header">
      <text class="section-title">ä»Šæ—¥æ‘„å…¥</text>
    </view>
    <view class="intake-summary">
      <view class="summary-item">
        <text class="label">æ€»çƒ­é‡</text>
        <text class="value highlight">{{macroSummary.calories || 0}} kcal</text>
      </view>
      <view class="summary-item">
        <text class="label">çƒ­é‡ç³»æ•°</text>
        <text class="value">{{macroSummary.caloriesPerKg !== '' ? macroSummary.caloriesPerKg : 'â€”'}} kcal/kg</text>
      </view>
      <view class="summary-item">
        <text class="label">å¤©ç„¶è›‹ç™½</text>
        <text class="value">{{macroSummary.naturalProtein || 0}} g</text>
      </view>
      <view class="summary-item">
        <text class="label">ç‰¹æ®Šè›‹ç™½</text>
        <text class="value">{{macroSummary.specialProtein || 0}} g</text>
      </view>
      <view class="summary-item">
        <text class="label">å¤©ç„¶è›‹ç™½ç³»æ•°</text>
        <text class="value">{{macroSummary.naturalCoefficient !== '' ? macroSummary.naturalCoefficient : 'â€”'}} g/kg/d</text>
      </view>
      <view class="summary-item">
        <text class="label">ç‰¹æ®Šè›‹ç™½ç³»æ•°</text>
        <text class="value">{{macroSummary.specialCoefficient !== '' ? macroSummary.specialCoefficient : 'â€”'}} g/kg/d</text>
      </view>
    </view>
    <view class="macro-ratio">
      <view class="macro-ratio-header">
        <view class="macro-ratio-title">ä¾›èƒ½å æ¯”</view>
      </view>
      <view class="macro-ratio-row">
        <view class="macro-ratio-row-main">
          <text class="macro-ratio-label">è›‹ç™½</text>
          <text class="macro-ratio-value">{{macroRatios.protein || 0}}%</text>
        </view>
        <text class="macro-ratio-row-hint">å‚è€ƒ 10%-15%</text>
      </view>
      <view class="macro-ratio-row">
        <view class="macro-ratio-row-main">
          <text class="macro-ratio-label">ç¢³æ°´</text>
          <text class="macro-ratio-value">{{macroRatios.carbs || 0}}%</text>
        </view>
        <text class="macro-ratio-row-hint">å‚è€ƒ 55%-60%</text>
      </view>
      <view class="macro-ratio-row">
        <view class="macro-ratio-row-main">
          <view class="macro-ratio-label-group">
            <text class="macro-ratio-label">è„‚è‚ª</text>
            <text class="ratio-info-icon" bindtap="showFatRatioPopup">i</text>
          </view>
          <text class="macro-ratio-value">{{macroRatios.fat || 0}}%</text>
        </view>
        <text class="macro-ratio-row-hint">å‚è€ƒ {{fatRatioRangeText || '--'}}</text>
      </view>
    </view>
  </view>

  <!-- Records Section -->
  <view class="section records-section">
    <text class="section-title">ä»Šæ—¥æ•°æ®æ±‡æ€»</text>
    
    <!-- æ‘„å…¥æ¥æºæ¦‚è§ˆ -->
    <view class="records-summary">
      <view class="summary-card milk-card">
        <view class="card-header">
          <text class="card-title">å–‚å¥¶</text>
          <text class="card-meta">çƒ­é‡ {{intakeOverview.milk.totalCalories || 0}} kcal</text>
        </view>
        <view class="card-body milk-body">
          <view class="milk-column">
            <text class="column-title">å¤©ç„¶</text>
            <view class="stat-row">
              <text>ä½“ç§¯</text>
              <text>{{intakeOverview.milk.normal.volume || 0}} ml</text>
            </view>
            <view class="stat-row">
              <text>è›‹ç™½</text>
              <text>{{intakeOverview.milk.normal.protein || 0}} g</text>
            </view>
            <view class="stat-row">
              <text>è›‹ç™½ç³»æ•°</text>
              <text>{{intakeOverview.milk.normal.coefficient !== '' ? intakeOverview.milk.normal.coefficient : 'â€”'}} g/kg/d</text>
            </view>
            <view class="stat-row">
              <text>çƒ­é‡</text>
              <text>{{intakeOverview.milk.normal.calories || 0}} kcal</text>
            </view>
            <view class="stat-row">
              <text>ç¢³æ°´</text>
              <text>{{intakeOverview.milk.normal.carbs || 0}} g</text>
            </view>
            <view class="stat-row">
              <text>è„‚è‚ª</text>
              <text>{{intakeOverview.milk.normal.fat || 0}} g</text>
            </view>
          </view>
          <view class="milk-column">
            <text class="column-title">ç‰¹å¥¶</text>
            <view class="stat-row">
              <text>ä½“ç§¯</text>
              <text>{{intakeOverview.milk.special.volume || 0}} ml</text>
            </view>
            <view class="stat-row">
              <text>è›‹ç™½</text>
              <text>{{intakeOverview.milk.special.protein || 0}} g</text>
            </view>
            <view class="stat-row">
              <text>è›‹ç™½ç³»æ•°</text>
              <text>{{intakeOverview.milk.special.coefficient !== '' ? intakeOverview.milk.special.coefficient : 'â€”'}} g/kg/d</text>
            </view>
            <view class="stat-row">
              <text>çƒ­é‡</text>
              <text>{{intakeOverview.milk.special.calories || 0}} kcal</text>
            </view>
            <view class="stat-row">
              <text>ç¢³æ°´</text>
              <text>{{intakeOverview.milk.special.carbs || 0}} g</text>
            </view>
            <view class="stat-row">
              <text>è„‚è‚ª</text>
              <text>{{intakeOverview.milk.special.fat || 0}} g</text>
            </view>
          </view>
        </view>
      </view>

      <view class="summary-card food-card">
        <view class="card-header">
          <text class="card-title">é£Ÿç‰©</text>
          <text class="card-meta">çƒ­é‡ {{intakeOverview.food.totalCalories || 0}} kcal</text>
        </view>
        <view class="card-body food-body">
          <view class="body-summary">
            <text>è›‹ç™½ {{intakeOverview.food.protein || 0}} g</text>
            <text>è›‹ç™½ç³»æ•° {{intakeOverview.food.coefficient !== '' ? intakeOverview.food.coefficient : 'â€”'}} g/kg/d</text>
            <text>ç¢³æ°´ {{intakeOverview.food.carbs || 0}} g Â· è„‚è‚ª {{intakeOverview.food.fat || 0}} g</text>
          </view>
          <view class="empty-record" wx:if="{{foodIntakes.length === 0}}">
            <text>æš‚æ— é£Ÿç‰©æ‘„å…¥è®°å½•</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- é€‰é¡¹å¡æ ‡é¢˜ -->
    <view class="tabs">
      <view class="tab {{activeTab === 'feeding' ? 'active' : ''}}" bindtap="switchTab" data-tab="feeding">
        <text>å–‚å¥¶è®°å½•</text>
      </view>
      <view class="tab {{activeTab === 'food' ? 'active' : ''}}" bindtap="switchTab" data-tab="food">
        <text>é£Ÿç‰©è®°å½•</text>
      </view>
      <view class="tab {{activeTab === 'medication' ? 'active' : ''}}" bindtap="switchTab" data-tab="medication">
        <text>ç”¨è¯è®°å½•</text>
      </view>
    </view>
    
    <!-- å–‚å…»è®°å½• -->
    <view class="tab-content" hidden="{{activeTab !== 'feeding'}}">
      <view class="records-list">
        <view class="record-item" wx:for="{{feedingsDisplay}}" wx:key="index">
          <view class="record-content">
            <feeding-record-item record="{{item}}" showLabel="{{false}}" bind:recordtap="openEditModal" data-index="{{index}}" />
          </view>
          <!-- æ“ä½œæŒ‰é’® -->
          <view class="action-buttons">
            <view class="action-btn edit-btn" bindtap="openEditModal" data-index="{{index}}">
              <image class="action-icon" src="/images/icons/edit.svg" mode="aspectFit"></image>
            </view>
            <view class="action-btn delete-btn" bindtap="deleteFeeding" data-index="{{index}}">
              <image class="action-icon" src="/images/icons/delete.svg" mode="aspectFit"></image>
            </view>
          </view>
        </view>
        <view class="empty-record" wx:if="{{feedingsDisplay.length === 0}}">
          <text>æš‚æ— å–‚å…»è®°å½•</text>
        </view>
      </view>
    </view>

    <!-- é£Ÿç‰©è®°å½• -->
    <view class="tab-content" hidden="{{activeTab !== 'food'}}">
      <view class="records-list">
        <view class="food-record-item" wx:for="{{foodIntakes}}" wx:key="_id">
          <view class="record-content">
            <food-record-item record="{{item}}" />
          </view>
          <view class="action-buttons">
            <view class="action-btn edit-btn" bindtap="openEditFoodModal" data-index="{{index}}" data-id="{{item._id}}">
              <image class="action-icon" src="/images/icons/edit.svg" mode="aspectFit"></image>
            </view>
            <view class="action-btn delete-btn" bindtap="deleteFoodIntake" data-index="{{index}}" data-id="{{item._id}}">
              <image class="action-icon" src="/images/icons/delete.svg" mode="aspectFit"></image>
            </view>
          </view>
        </view>
        <view class="empty-record" wx:if="{{foodIntakes.length === 0}}">
          <text>æš‚æ— é£Ÿç‰©æ‘„å…¥è®°å½•</text>
        </view>
      </view>
    </view>

    <!-- è¯ç‰©è®°å½• -->
    <view class="tab-content" hidden="{{activeTab !== 'medication'}}">
      <view class="medication-records">
        <!-- æŒ‰è¯ç‰©åç§°åˆ†ç»„æ˜¾ç¤º -->
        <view class="medication-group" wx:for="{{groupedMedicationRecords}}" wx:key="medicationName" wx:for-item="group">
          <view class="medication-group-header">
            <text class="medication-group-name">{{group.medicationName}}</text>
            <text class="medication-group-count">ä»Šæ—¥{{group.totalCount}}æ¬¡</text>
          </view>
          
          <!-- è¯¥è¯ç‰©çš„æ‰€æœ‰è®°å½• -->
          <view class="medication-group-records">
            <view class="medication-record-item" wx:for="{{group.records}}" wx:key="originalIndex" wx:for-item="record">
              <view class="record-content" data-index="{{record.originalIndex}}">
                <view class="medication-time-dose">
                  <text class="medication-time">{{record.actualTime}}</text>
                  <text class="medication-volume">{{record.dosage}}{{record.unit}}</text>
                </view>
              </view>
              <!-- æ“ä½œæŒ‰é’® -->
              <view class="action-buttons">
                <view class="action-btn edit-btn" bindtap="openMedicationRecordModal" data-medication-id="{{record._id}}" data-action="view">
                  <image class="action-icon" src="/images/icons/edit.svg" mode="aspectFit"></image>
                </view>
                <view class="action-btn delete-btn" bindtap="deleteMedication" data-medication-id="{{record._id}}" data-action="delete">
                  <image class="action-icon" src="/images/icons/delete.svg" mode="aspectFit"></image>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <view class="empty-record" wx:if="{{medicationRecords.length === 0}}">
          <text>æš‚æ— ç”¨è¯è®°å½•</text>
        </view>
      </view>
    </view>
  </view>

  <fat-ratio-popup
    visible="{{showFatRatioPopup}}"
    lines="{{fatRatioPopupLines}}"
    bind:close="hideFatRatioPopup"
  />

  <!-- Medication Modal -->
  <view class="modal" wx:if="{{modals.medication}}" bindtap="closeMedicationModal" catchtouchmove="preventBubble">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>è®°å½•ç”¨è¯</text>
      </view>
      <view class="modal-body">
        <view class="modal-info-row">
          <text class="modal-label">è¯ç‰©åç§°:</text>
          <picker mode="selector" range="{{medicationsList}}" range-key="name" value="{{selectedMedicationIndex}}" bindchange="onMedicationPickerChange">
            <view class="modal-picker">
              <text class="modal-value">{{selectedMedicationInfo ? selectedMedicationInfo.name : 'è¯·é€‰æ‹©è¯ç‰©'}}</text>
              <text class="edit-icon">â–¼</text>
            </view>
          </picker>
        </view>
        <view class="modal-info-row">
          <text class="modal-label">è¯ç‰©å‰‚é‡:</text>
          <view class="dosage-input-container">
            <input type="digit" class="dosage-input" value="{{currentModalDosage}}" bindinput="onMedicationDosageChange" placeholder="è¯·è¾“å…¥è¯ç‰©å‰‚é‡" />
            <text class="dosage-unit">{{selectedMedicationInfo.unit}}</text>
          </view>
        </view>
        <view class="modal-info-row" wx:if="{{selectedMedicationInfo.frequency}}">
          <text class="modal-label">æœç”¨é¢‘ç‡:</text>
          <text class="modal-value">{{selectedMedicationInfo.frequency}}</text>
        </view>
        <view class="modal-info-row">
          <text class="modal-label">æœç”¨æ—¶é—´:</text>
          <picker mode="time" value="{{currentModalTime}}" start="00:00" end="23:59" bindchange="onMedicationTimeChange">
            <view class="modal-time-picker">{{currentModalTime}} <text class="edit-icon">âœ</text></view>
          </picker>
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeMedicationModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="recordMedication">ç¡®è®¤</button>
      </view>
    </view>
  </view>
  
  <!-- ç¼–è¾‘è®°å½•å¼¹çª— -->
  <feeding-modal
    visible="{{modals.edit}}"
    title="ç¼–è¾‘å–‚å¥¶è®°å½•"
    feedingData="{{editingFeedingDisplay}}"
    showGoalHint="{{false}}"
    confirmText="ä¿å­˜"
    bind:close="closeEditModal"
    bind:confirm="saveEditedFeeding"
    bind:timechange="handleEditModalTimeChange"
    bind:inputchange="handleEditModalInputChange"
    bind:adjust="handleEditModalAdjust"
    bind:typechange="handleEditModalTypeChange"
  />
  
  <!-- è¯ç‰©è®°å½•è¯¦æƒ…å¼¹çª— -->
  <view class="modal" wx:if="{{modals.medicationRecord}}" bindtap="closeMedicationRecordModal" catchtouchmove="preventBubble">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>è¯ç‰©è®°å½•è¯¦æƒ…</text>
      </view>
      <view class="modal-body">
        <view class="modal-info-row">
          <text class="modal-label">è¯ç‰©åç§°:</text>
          <text class="modal-value">{{selectedMedicationRecord.medicationName}}</text>
        </view>
        <view class="modal-info-row">
          <text class="modal-label">è¯ç‰©å‰‚é‡:</text>
          <view class="dosage-input-container">
            <input type="digit" class="dosage-input" value="{{selectedMedicationRecord.dosage}}" bindinput="onMedicationRecordDosageChange" />
            <text class="dosage-unit">{{selectedMedicationRecord.unit}}</text>
          </view>
        </view>
        <view class="modal-info-row">
          <text class="modal-label">æœç”¨æ—¶é—´:</text>
          <picker mode="time" value="{{selectedMedicationRecord.actualTime}}" start="00:00" end="23:59" bindchange="onMedicationRecordTimeChange">
            <view class="modal-time-picker">{{selectedMedicationRecord.actualTime}} <text class="edit-icon">âœ</text></view>
          </picker>
        </view>
        <view class="modal-info-row" wx:if="{{selectedMedicationRecord.frequency}}">
          <text class="modal-label">æœç”¨é¢‘ç‡:</text>
          <text class="modal-value">{{selectedMedicationRecord.frequency}}</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeMedicationRecordModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="saveMedicationRecordChanges">ä¿å­˜</button>
      </view>
    </view>
  </view>
  
  <!-- å¿«æ·è®°å½•å¼¹çª— -->
  <feeding-modal
    visible="{{modals.quickInput}}"
    title="æ·»åŠ å–‚å¥¶è®°å½•"
    feedingData="{{quickFeedingData}}"
    showGoalHint="{{true}}"
    quickGoalTarget="{{quickGoalTarget}}"
    quickGoalSuggestion="{{quickGoalSuggestion}}"
    naturalProteinCoefficientInput="{{naturalProteinCoefficientInput}}"
    specialProteinCoefficientInput="{{specialProteinCoefficientInput}}"
    calorieCoefficientInput="{{calorieCoefficientInput}}"
    bind:close="hideQuickInputModal"
    bind:confirm="saveQuickFeeding"
    bind:timechange="handleQuickModalTimeChange"
    bind:inputchange="handleQuickModalInputChange"
    bind:adjust="handleQuickModalAdjust"
    bind:typechange="handleQuickModalTypeChange"
    bind:goaltarget="handleQuickModalGoalTargetChange"
    bind:coefficient="handleQuickModalCoefficientChange"
  />

  <!-- é£Ÿç‰©æ‘„å…¥å¼¹çª— -->
  <view class="modal feeding-modal" wx:if="{{modals.foodIntake}}" bindtap="hideFoodIntakeModal" catchtouchmove="preventBubble">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>æ·»åŠ é£Ÿç‰©è®°å½•</text>
      </view>
      <scroll-view class="modal-body modal-scroll" scroll-y="true" enhanced="true" show-scrollbar="false">
        <view class="content-box">
          <view class="input-group">
          <text class="label">é£Ÿç‰©</text>
          <view class="food-selection-card">
            <view class="food-list-header">
              <view class="food-header-title">è¯·é€‰æ‹©é£Ÿç‰©</view>
              <view class="food-add-btn" bindtap="openFoodManage">
                <text class="food-add-icon">ï¼‹</text>
                <text>æ·»åŠ é£Ÿç‰©</text>
              </view>
            </view>
            <view class="food-search-input">
              <text class="search-icon">ğŸ”</text>
              <input type="text" value="{{foodSearchQuery}}" placeholder="æœç´¢é£Ÿç‰©åç§°æˆ–ç±»åˆ«" confirm-type="search" bindinput="onFoodSearchInput" />
            </view>
            <scroll-view class="food-option-list" scroll-y="true">
                <view class="food-option {{newFoodIntake.foodId === item._id ? 'selected' : ''}}"
                      wx:for="{{filteredFoodOptions}}" wx:key="_id"
                      data-id="{{item._id}}" bindtap="onFoodOptionTap">
                  <view class="food-option-main">
                    <text class="food-option-name">{{item.name}}</text>
                    <text class="food-option-tag">{{item.category || 'æœªåˆ†ç±»'}}</text>
                  </view>
                  <text class="food-option-sub" wx:if="{{item.aliasText}}">{{item.aliasText}}</text>
                </view>
                <view class="food-option-empty" wx:if="{{filteredFoodOptions.length === 0}}">
                  <text>æœªæ‰¾åˆ°åŒ¹é…çš„é£Ÿç‰©ï¼Œè¯·è°ƒæ•´æœç´¢æ¡ä»¶</text>
                </view>
              </scroll-view>
            </view>
          </view>
          <view class="input-group">
            <text class="label">é‡é‡ ({{newFoodIntake.unit || 'g'}})</text>
            <input type="digit" value="{{newFoodIntake.quantity}}" bindinput="onFoodQuantityInput" placeholder="è¯·è¾“å…¥é‡é‡" />
          </view>
          <view class="input-group">
            <text class="label">æ—¶é—´</text>
            <picker mode="time" value="{{newFoodIntake.recordTime}}" bindchange="onFoodRecordTimeChange">
              <view class="picker-value">{{newFoodIntake.recordTime || 'é€‰æ‹©æ—¶é—´'}}</view>
            </picker>
          </view>
          <view class="nutrition-preview" wx:if="{{newFoodIntake.nutritionPreview}}">
            <view class="preview-row">
              <text>çƒ­é‡</text>
              <text>{{newFoodIntake.nutritionPreview.calories}} kcal</text>
            </view>
            <view class="preview-row">
              <text>è›‹ç™½</text>
              <text>{{newFoodIntake.nutritionPreview.protein}} g</text>
            </view>
            <view class="preview-row">
              <text>ç¢³æ°´</text>
              <text>{{newFoodIntake.nutritionPreview.carbs}} g</text>
            </view>
            <view class="preview-row">
              <text>è„‚è‚ª</text>
              <text>{{newFoodIntake.nutritionPreview.fat}} g</text>
            </view>
            <view class="preview-row">
              <text>è†³çº¤</text>
              <text>{{newFoodIntake.nutritionPreview.fiber}} g</text>
            </view>
            <view class="preview-row">
              <text>é’ </text>
              <text>{{newFoodIntake.nutritionPreview.sodium}} mg</text>
            </view>
          </view>
        </view>
      </scroll-view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideFoodIntakeModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="saveFoodIntake">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- é£Ÿç‰©æ‘„å…¥å®éªŒå¼¹çª— -->
  <food-intake-modal
    visible="{{modals.foodIntakeExperiment}}"
    step="{{foodExperimentStep}}"
    searchQuery="{{foodExperimentSearchQuery}}"
    categories="{{foodExperimentCategories}}"
    activeCategory="{{foodExperimentCategory}}"
    options="{{filteredFoodExperimentOptions}}"
    selectedFoodId="{{foodExperiment.foodId}}"
    foodExperiment="{{foodExperiment}}"
    confirmDisabled="{{!foodExperiment.foodId}}"
    formCancelText="{{foodModalMode === 'edit' ? 'å–æ¶ˆ' : 'ä¸Šä¸€æ­¥'}}"
    bind:close="hideFoodIntakeExperimentModal"
    bind:openmanage="openFoodManage"
    bind:searchinput="onFoodExperimentSearchInput"
    bind:categorytap="onFoodExperimentCategoryTap"
    bind:optiontap="onFoodExperimentOptionTap"
    bind:confirmselect="confirmFoodExperimentSelection"
    bind:backtoselect="backToFoodExperimentSelection"
    bind:quantityinput="onFoodExperimentQuantityInput"
    bind:timechange="onFoodExperimentRecordTimeChange"
    bind:formcancel="handleFoodExperimentFormCancel"
    bind:formsave="saveFoodIntakeExperiment"
  />

  <!-- æ’ä¾¿è®°å½•å¼¹çª— -->
  <view class="modal bowel-record-modal" wx:if="{{modals.bowelRecord}}" bindtap="hideBowelRecordModal" catchtouchmove="preventBubble">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>è®°å½•æ’ä¾¿</text>
      </view>
      <scroll-view class="modal-body" scroll-y="true" enhanced="true" show-scrollbar="false">
        <!-- æ—¶é—´é€‰æ‹© -->
        <view class="modal-info-row">
          <text class="modal-label">æ—¶é—´:</text>
          <picker mode="time" value="{{newBowelRecord.time}}" start="00:00" end="23:59" bindchange="onBowelTimeChange">
            <view class="modal-time-picker">{{newBowelRecord.time}} <text class="edit-icon">âœ</text></view>
          </picker>
        </view>
        
        <!-- ç±»å‹é€‰æ‹© -->
        <view class="modal-info-row">
          <text class="modal-label">ç±»å‹:</text>
          <view class="bowel-type-selector">
            <view class="type-option {{newBowelRecord.type === 'stool' ? 'selected' : ''}}" 
                  data-field="type" data-value="stool" bindtap="onBowelRecordSelect">
              <text>å¤§ä¾¿</text>
            </view>
            <view class="type-option {{newBowelRecord.type === 'urine' ? 'selected' : ''}}" 
                  data-field="type" data-value="urine" bindtap="onBowelRecordSelect">
              <text>å°ä¾¿</text>
            </view>
            <view class="type-option {{newBowelRecord.type === 'mixed' ? 'selected' : ''}}" 
                  data-field="type" data-value="mixed" bindtap="onBowelRecordSelect">
              <text>æ··åˆ</text>
            </view>
          </view>
        </view>
        
        <!-- å¤§ä¾¿è¯¦ç»†ä¿¡æ¯ï¼ˆä»…åœ¨å¤§ä¾¿æˆ–æ··åˆæ—¶æ˜¾ç¤ºï¼‰ -->
        <view class="bowel-detail-section" wx:if="{{newBowelRecord.type === 'stool' || newBowelRecord.type === 'mixed'}}">
          <!-- æ€§çŠ¶ -->
          <view class="modal-info-row">
            <text class="modal-label">æ€§çŠ¶:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{newBowelRecord.consistency === 'liquid' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="liquid" bindtap="onBowelRecordSelect">
                <text>æ°´æ ·</text>
              </view>
              <view class="option-item {{newBowelRecord.consistency === 'loose' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="loose" bindtap="onBowelRecordSelect">
                <text>ç¨€ä¾¿</text>
              </view>
              <view class="option-item {{newBowelRecord.consistency === 'soft' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="soft" bindtap="onBowelRecordSelect">
                <text>ç³ŠçŠ¶</text>
              </view>
              <view class="option-item {{newBowelRecord.consistency === 'normal' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="normal" bindtap="onBowelRecordSelect">
                <text>æ­£å¸¸</text>
              </view>
              <view class="option-item {{newBowelRecord.consistency === 'hard' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="hard" bindtap="onBowelRecordSelect">
                <text>å¹²ç¡¬</text>
              </view>
            </view>
          </view>
          
          <!-- é¢œè‰² -->
          <view class="modal-info-row">
            <text class="modal-label">é¢œè‰²:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{newBowelRecord.color === 'yellow' ? 'selected' : ''}}" 
                    data-field="color" data-value="yellow" bindtap="onBowelRecordSelect">
                <text>é»„è‰²</text>
              </view>
              <view class="option-item {{newBowelRecord.color === 'green' ? 'selected' : ''}}" 
                    data-field="color" data-value="green" bindtap="onBowelRecordSelect">
                <text>ç»¿è‰²</text>
              </view>
              <view class="option-item {{newBowelRecord.color === 'brown' ? 'selected' : ''}}" 
                    data-field="color" data-value="brown" bindtap="onBowelRecordSelect">
                <text>è¤è‰²</text>
              </view>
              <view class="option-item {{newBowelRecord.color === 'white' ? 'selected' : ''}}" 
                    data-field="color" data-value="white" bindtap="onBowelRecordSelect">
                <text>ç™½è‰²</text>
              </view>
              <view class="option-item {{newBowelRecord.color === 'red' ? 'selected' : ''}}" 
                    data-field="color" data-value="red" bindtap="onBowelRecordSelect">
                <text>çº¢è‰²</text>
              </view>
              <view class="option-item {{newBowelRecord.color === 'black' ? 'selected' : ''}}" 
                    data-field="color" data-value="black" bindtap="onBowelRecordSelect">
                <text>é»‘è‰²</text>
              </view>
            </view>
          </view>
          
          <!-- æ°”å‘³ -->
          <view class="modal-info-row">
            <text class="modal-label">æ°”å‘³:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{newBowelRecord.smell === 'normal' ? 'selected' : ''}}" 
                    data-field="smell" data-value="normal" bindtap="onBowelRecordSelect">
                <text>æ­£å¸¸</text>
              </view>
              <view class="option-item {{newBowelRecord.smell === 'sour' ? 'selected' : ''}}" 
                    data-field="smell" data-value="sour" bindtap="onBowelRecordSelect">
                <text>é…¸è‡­</text>
              </view>
              <view class="option-item {{newBowelRecord.smell === 'fishy' ? 'selected' : ''}}" 
                    data-field="smell" data-value="fishy" bindtap="onBowelRecordSelect">
                <text>è…¥è‡­</text>
              </view>
              <view class="option-item {{newBowelRecord.smell === 'odorless' ? 'selected' : ''}}" 
                    data-field="smell" data-value="odorless" bindtap="onBowelRecordSelect">
                <text>æ— å‘³</text>
              </view>
            </view>
          </view>
          
          <!-- åˆ†é‡ -->
          <view class="modal-info-row">
            <text class="modal-label">åˆ†é‡:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{newBowelRecord.amount === 'small' ? 'selected' : ''}}" 
                    data-field="amount" data-value="small" bindtap="onBowelRecordSelect">
                <text>å°‘é‡</text>
              </view>
              <view class="option-item {{newBowelRecord.amount === 'medium' ? 'selected' : ''}}" 
                    data-field="amount" data-value="medium" bindtap="onBowelRecordSelect">
                <text>é€‚é‡</text>
              </view>
              <view class="option-item {{newBowelRecord.amount === 'large' ? 'selected' : ''}}" 
                    data-field="amount" data-value="large" bindtap="onBowelRecordSelect">
                <text>å¤§é‡</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- å¤‡æ³¨ -->
        <view class="modal-info-row">
          <text class="modal-label">å¤‡æ³¨:</text>
          <textarea class="notes-input" placeholder="å¯é€‰ï¼Œè®°å½•ç‰¹æ®Šæƒ…å†µ" 
                    value="{{newBowelRecord.notes}}" data-field="notes" bindinput="onBowelRecordInput"></textarea>
        </view>
      </scroll-view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideBowelRecordModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="saveBowelRecord">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- ç¼–è¾‘æ’ä¾¿è®°å½•å¼¹çª— -->
  <view class="modal bowel-edit-modal" wx:if="{{modals.bowelEdit}}" bindtap="hideBowelEditModal" catchtouchmove="preventBubble">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text>ç¼–è¾‘æ’ä¾¿è®°å½•</text>
      </view>
      <scroll-view class="modal-body" scroll-y="true" enhanced="true" show-scrollbar="false">
        <!-- æ—¶é—´é€‰æ‹© -->
        <view class="modal-info-row">
          <text class="modal-label">æ—¶é—´:</text>
          <picker mode="time" value="{{editingBowelRecord.timeString}}" start="00:00" end="23:59" bindchange="onEditBowelTimeChange">
            <view class="modal-time-picker">{{editingBowelRecord.timeString}} <text class="edit-icon">âœ</text></view>
          </picker>
        </view>
        
        <!-- ç±»å‹é€‰æ‹© -->
        <view class="modal-info-row">
          <text class="modal-label">ç±»å‹:</text>
          <view class="bowel-type-selector">
            <view class="type-option {{editingBowelRecord.type === 'stool' ? 'selected' : ''}}" 
                  data-field="type" data-value="stool" bindtap="onEditBowelRecordSelect">
              <text>å¤§ä¾¿</text>
            </view>
            <view class="type-option {{editingBowelRecord.type === 'urine' ? 'selected' : ''}}" 
                  data-field="type" data-value="urine" bindtap="onEditBowelRecordSelect">
              <text>å°ä¾¿</text>
            </view>
            <view class="type-option {{editingBowelRecord.type === 'mixed' ? 'selected' : ''}}" 
                  data-field="type" data-value="mixed" bindtap="onEditBowelRecordSelect">
              <text>æ··åˆ</text>
            </view>
          </view>
        </view>
        
        <!-- å¤§ä¾¿è¯¦ç»†ä¿¡æ¯ï¼ˆä»…åœ¨å¤§ä¾¿æˆ–æ··åˆæ—¶æ˜¾ç¤ºï¼‰ -->
        <view class="bowel-detail-section" wx:if="{{editingBowelRecord.type === 'stool' || editingBowelRecord.type === 'mixed'}}">
          <!-- æ€§çŠ¶ -->
          <view class="modal-info-row">
            <text class="modal-label">æ€§çŠ¶:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{editingBowelRecord.consistency === 'liquid' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="liquid" bindtap="onEditBowelRecordSelect">
                <text>æ°´æ ·</text>
              </view>
              <view class="option-item {{editingBowelRecord.consistency === 'loose' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="loose" bindtap="onEditBowelRecordSelect">
                <text>ç¨€ä¾¿</text>
              </view>
              <view class="option-item {{editingBowelRecord.consistency === 'soft' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="soft" bindtap="onEditBowelRecordSelect">
                <text>ç³ŠçŠ¶</text>
              </view>
              <view class="option-item {{editingBowelRecord.consistency === 'normal' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="normal" bindtap="onEditBowelRecordSelect">
                <text>æ­£å¸¸</text>
              </view>
              <view class="option-item {{editingBowelRecord.consistency === 'hard' ? 'selected' : ''}}" 
                    data-field="consistency" data-value="hard" bindtap="onEditBowelRecordSelect">
                <text>å¹²ç¡¬</text>
              </view>
            </view>
          </view>
          
          <!-- é¢œè‰² -->
          <view class="modal-info-row">
            <text class="modal-label">é¢œè‰²:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{editingBowelRecord.color === 'yellow' ? 'selected' : ''}}" 
                    data-field="color" data-value="yellow" bindtap="onEditBowelRecordSelect">
                <text>é»„è‰²</text>
              </view>
              <view class="option-item {{editingBowelRecord.color === 'green' ? 'selected' : ''}}" 
                    data-field="color" data-value="green" bindtap="onEditBowelRecordSelect">
                <text>ç»¿è‰²</text>
              </view>
              <view class="option-item {{editingBowelRecord.color === 'brown' ? 'selected' : ''}}" 
                    data-field="color" data-value="brown" bindtap="onEditBowelRecordSelect">
                <text>è¤è‰²</text>
              </view>
              <view class="option-item {{editingBowelRecord.color === 'white' ? 'selected' : ''}}" 
                    data-field="color" data-value="white" bindtap="onEditBowelRecordSelect">
                <text>ç™½è‰²</text>
              </view>
              <view class="option-item {{editingBowelRecord.color === 'red' ? 'selected' : ''}}" 
                    data-field="color" data-value="red" bindtap="onEditBowelRecordSelect">
                <text>çº¢è‰²</text>
              </view>
              <view class="option-item {{editingBowelRecord.color === 'black' ? 'selected' : ''}}" 
                    data-field="color" data-value="black" bindtap="onEditBowelRecordSelect">
                <text>é»‘è‰²</text>
              </view>
            </view>
          </view>
          
          <!-- æ°”å‘³ -->
          <view class="modal-info-row">
            <text class="modal-label">æ°”å‘³:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{editingBowelRecord.smell === 'normal' ? 'selected' : ''}}" 
                    data-field="smell" data-value="normal" bindtap="onEditBowelRecordSelect">
                <text>æ­£å¸¸</text>
              </view>
              <view class="option-item {{editingBowelRecord.smell === 'sour' ? 'selected' : ''}}" 
                    data-field="smell" data-value="sour" bindtap="onEditBowelRecordSelect">
                <text>é…¸è‡­</text>
              </view>
              <view class="option-item {{editingBowelRecord.smell === 'fishy' ? 'selected' : ''}}" 
                    data-field="smell" data-value="fishy" bindtap="onEditBowelRecordSelect">
                <text>è…¥è‡­</text>
              </view>
              <view class="option-item {{editingBowelRecord.smell === 'odorless' ? 'selected' : ''}}" 
                    data-field="smell" data-value="odorless" bindtap="onEditBowelRecordSelect">
                <text>æ— å‘³</text>
              </view>
            </view>
          </view>
          
          <!-- åˆ†é‡ -->
          <view class="modal-info-row">
            <text class="modal-label">åˆ†é‡:</text>
            <view class="bowel-option-selector">
              <view class="option-item {{editingBowelRecord.amount === 'small' ? 'selected' : ''}}" 
                    data-field="amount" data-value="small" bindtap="onEditBowelRecordSelect">
                <text>å°‘é‡</text>
              </view>
              <view class="option-item {{editingBowelRecord.amount === 'medium' ? 'selected' : ''}}" 
                    data-field="amount" data-value="medium" bindtap="onEditBowelRecordSelect">
                <text>é€‚é‡</text>
              </view>
              <view class="option-item {{editingBowelRecord.amount === 'large' ? 'selected' : ''}}" 
                    data-field="amount" data-value="large" bindtap="onEditBowelRecordSelect">
                <text>å¤§é‡</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- å¤‡æ³¨ -->
        <view class="modal-info-row">
          <text class="modal-label">å¤‡æ³¨:</text>
          <textarea class="notes-input" placeholder="å¯é€‰ï¼Œè®°å½•ç‰¹æ®Šæƒ…å†µ" 
                    value="{{editingBowelRecord.notes}}" data-field="notes" bindinput="onEditBowelRecordInput"></textarea>
        </view>
      </scroll-view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideBowelEditModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="saveEditedBowelRecord">ä¿å­˜</button>
      </view>
    </view>
  </view>
</view> 
