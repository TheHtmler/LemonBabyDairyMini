<!-- pages/data-analysis/index.wxml -->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">æ•°æ®åŠ è½½ä¸­...</text>
  </view>
  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else class="content">
    <!-- æ—¶é—´ç»´åº¦é€‰æ‹© -->
    <view class="dimension-selector">
      <view class="dimension-tabs">
        <view class="tab-item {{timeDimension === 'week' ? 'active' : ''}}" bindtap="onTimeDimensionChange" data-dimension="week">
          <text class="tab-text">å‘¨è§†å›¾</text>
        </view>
        <view class="tab-item {{timeDimension === 'month' ? 'active' : ''}}" bindtap="onTimeDimensionChange" data-dimension="month">
          <text class="tab-text">æœˆè§†å›¾</text>
        </view>
      </view>
    </view>
    <!-- æ—¥æœŸèŒƒå›´å¯¼èˆª -->
    <view class="date-navigation">
      <view class="nav-btn" bindtap="onPrevious" hover-class="nav-btn-hover">
        <text class="nav-icon">â—€</text>
      </view>
      <view class="date-range {{timeDimension === 'month' ? 'clickable' : ''}}" bindtap="{{timeDimension === 'month' ? 'onDatePicker' : ''}}">
        <text class="date-text">{{dateRangeText}}</text>
        <text wx:if="{{timeDimension === 'month'}}" class="date-picker-icon">ğŸ“…</text>
      </view>
      <view class="nav-btn" bindtap="onNext" hover-class="nav-btn-hover">
        <text class="nav-icon">â–¶</text>
      </view>
    </view>
    <!-- æ—¥æœŸé€‰æ‹©å™¨å¼¹çª— -->
    <view wx:if="{{showDatePicker}}" class="date-picker-mask" bindtap="onCloseDatePicker">
      <view class="date-picker-modal" catchtap="stopPropagation">
        <view class="picker-header">
          <text class="picker-title">é€‰æ‹©æœˆä»½</text>
          <view class="picker-close" bindtap="onCloseDatePicker">âœ•</view>
        </view>
        <view class="picker-content">
          <!-- å¹´ä»½é€‰æ‹© -->
          <view class="picker-row">
            <view class="picker-btn" bindtap="onYearChange" data-offset="-1">
              <text>â—€</text>
            </view>
            <view class="picker-value">
              <text class="picker-year">{{pickerYear}}å¹´</text>
            </view>
            <view class="picker-btn" bindtap="onYearChange" data-offset="1">
              <text>â–¶</text>
            </view>
          </view>
          <!-- æœˆä»½é€‰æ‹© -->
          <view class="picker-months">
            <view wx:for="{{months}}" wx:key="*this" class="month-item {{pickerMonth === item ? 'active' : ''}}" bindtap="onMonthSelect" data-month="{{item}}">
              <text class="month-text">{{item}}æœˆ</text>
            </view>
          </view>
        </view>
        <view class="picker-footer">
          <view class="picker-action cancel" bindtap="onCloseDatePicker">
            <text>å–æ¶ˆ</text>
          </view>
          <view class="picker-action confirm" bindtap="onDatePickerConfirm">
            <text>ç¡®å®š</text>
          </view>
        </view>
      </view>
    </view>
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="statistics-card">
      <view class="stat-header">
        <text class="stat-title">æ•°æ®æ¦‚è§ˆ</text>
        <text class="stat-days">è®°å½•å¤©æ•°ï¼š{{statistics.totalDays}}å¤©</text>
      </view>
      <view class="stat-grid">
        <view class="stat-item">
          <text class="stat-label">å¹³å‡å¥¶é‡</text>
          <text class="stat-value">
            {{statistics.avgMilkVolume}}
            <text class="stat-unit">ml</text>
          </text>
        </view>
        <view class="stat-item">
          <text class="stat-label">å¹³å‡çƒ­é‡</text>
          <text class="stat-value">
            {{statistics.avgCalories}}
            <text class="stat-unit">kcal</text>
          </text>
        </view>
        <view class="stat-item">
          <text class="stat-label">å¤©ç„¶å¥¶</text>
          <text class="stat-value natural">
            {{statistics.avgNaturalMilk}}
            <text class="stat-unit">ml</text>
          </text>
        </view>
        <view class="stat-item">
          <text class="stat-label">ç‰¹å¥¶</text>
          <text class="stat-value special">
            {{statistics.avgSpecialMilk}}
            <text class="stat-unit">ml</text>
          </text>
        </view>
      </view>
    </view>
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{!hasData}}" class="empty-state">
      <view class="empty-icon">ğŸ“Š</view>
      <text class="empty-title">æš‚æ— æ•°æ®</text>
      <text class="empty-desc">æ‰€é€‰æ—¶é—´èŒƒå›´å†…æ²¡æœ‰å–‚å…»è®°å½•</text>
    </view>
    <!-- å›¾è¡¨åŒºåŸŸ -->
    <view wx:else class="charts-container">
      <!-- å¥¶é‡ç»Ÿè®¡æ›²çº¿ -->
      <view class="chart-section">
        <view class="chart-header">
          <text class="chart-title">ğŸ“ˆ å¥¶é‡ç»Ÿè®¡æ›²çº¿</text>
          <text class="chart-subtitle">æ¯æ—¥å¥¶é‡å˜åŒ–è¶‹åŠ¿</text>
        </view>
        <view class="chart-wrapper">
          <ec-canvas id="milk-chart" canvas-id="milk-chart" ec="{{ ec }}" bind:init="initMilkChart"></ec-canvas>
        </view>
      </view>
      <!-- è›‹ç™½è´¨ç³»æ•°æ¯”ä¾‹æ›²çº¿ -->
      <view class="chart-section">
        <view class="chart-header">
          <text class="chart-title">ğŸ¥› è›‹ç™½è´¨ç³»æ•°æ›²çº¿</text>
          <text class="chart-subtitle">æ€»è›‹ç™½ã€å¤©ç„¶è›‹ç™½ã€ç‰¹æ®Šè›‹ç™½ç³»æ•°ï¼ˆg/kgï¼‰</text>
        </view>
        <view class="chart-wrapper">
          <ec-canvas id="protein-chart" canvas-id="protein-chart" ec="{{ ec }}" bind:init="initProteinChart"></ec-canvas>
        </view>
      </view>
      <!-- æ€»çƒ­é‡æ›²çº¿ -->
      <view class="chart-section">
        <view class="chart-header">
          <text class="chart-title">ğŸ”¥ æ€»çƒ­é‡æ›²çº¿</text>
          <text class="chart-subtitle">æ¯æ—¥çƒ­é‡æ‘„å…¥è¶‹åŠ¿</text>
        </view>
        <view class="chart-wrapper">
          <ec-canvas id="calorie-chart" canvas-id="calorie-chart" ec="{{ ec }}" bind:init="initCalorieChart"></ec-canvas>
        </view>
      </view>
    </view>
  </view>
</view>