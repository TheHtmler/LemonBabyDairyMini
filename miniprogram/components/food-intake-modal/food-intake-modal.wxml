<view class="modal food-experiment-modal" wx:if="{{visible}}" bindtap="handleClose" catchtouchmove="stopBubble">
  <view class="modal-content food-experiment-content" catchtap="stopBubble">
    <view class="modal-header">
      <text>{{title}}</text>
    </view>
    <view class="food-experiment-body">
      <view class="food-experiment-search" wx:if="{{step === 'select'}}">
        <view class="food-search-input">
          <text class="search-icon">ğŸ”</text>
          <input type="text" value="{{searchQuery}}" placeholder="æœç´¢é£Ÿç‰©åç§°æˆ–ç±»åˆ«" confirm-type="search" bindinput="handleSearchInput" />
        </view>
      </view>
      <view class="food-experiment-select" wx:if="{{step === 'select'}}">
        <view class="food-experiment-categories">
          <view class="category-item {{activeCategory === (item.value || item) ? 'active' : ''}}"
                wx:for="{{categories}}" wx:key="value"
                data-category="{{item.value || item}}" bindtap="handleCategoryTap">
            <text>{{item.label || (item === 'recent' ? 'æœ€è¿‘' : item)}}</text>
          </view>
        </view>
        <view class="food-experiment-list-panel">
          <view class="food-list-header">
            <view class="food-header-title">è¯·é€‰æ‹©é£Ÿç‰©</view>
            <view class="food-add-btn" bindtap="handleOpenFoodManage">
              <text class="food-add-icon">ï¼‹</text>
              <text>æ·»åŠ é£Ÿç‰©</text>
            </view>
          </view>
          <scroll-view class="food-option-list food-experiment-option-list" scroll-y="true">
            <view class="food-option"
                  wx:for="{{options}}" wx:key="_id"
                  data-id="{{item._id}}" bindtap="handleOptionTap">
              <view class="food-option-main">
                <text class="food-option-name">{{item.name}}</text>
                <view class="food-option-add {{selectedFoodId === item._id ? 'active' : ''}}">âœ“</view>
              </view>
              <text class="food-option-sub" wx:if="{{item.aliasText}}">{{item.aliasText}}</text>
            </view>
            <view class="food-option-empty" wx:if="{{options.length === 0}}">
              <text>æœªæ‰¾åˆ°åŒ¹é…çš„é£Ÿç‰©ï¼Œè¯·è°ƒæ•´æœç´¢æ¡ä»¶</text>
            </view>
          </scroll-view>
        </view>
      </view>
      <view class="food-experiment-form-step" wx:if="{{step === 'form'}}">
        <view class="food-experiment-form-header">
          <view class="food-experiment-title-group">
            <text class="food-experiment-title">{{foodExperiment.food ? foodExperiment.food.name : 'æœªé€‰æ‹©é£Ÿç‰©'}}</text>
          </view>
          <view class="food-experiment-switch" bindtap="handleBackToSelect">æ›´æ¢é£Ÿç‰©</view>
        </view>
        <view class="food-experiment-form-body">
          <view class="input-group">
            <text class="label">ä»½é‡ ({{foodExperiment.unit || 'g'}})</text>
            <input type="digit" value="{{foodExperiment.quantity}}" bindinput="handleQuantityInput" placeholder="è¯·è¾“å…¥é‡é‡" />
          </view>
          <view class="input-group">
            <text class="label">{{timeLabel}}</text>
            <picker mode="time" value="{{foodExperiment.recordTime}}" bindchange="handleRecordTimeChange">
              <view class="picker-value">{{foodExperiment.recordTime || 'é€‰æ‹©æ—¶é—´'}}</view>
            </picker>
          </view>
          <view class="input-group">
            <text class="label">å¤‡æ³¨</text>
            <textarea class="notes-input" placeholder="å¯é€‰ï¼Œè®°å½•ç‰¹æ®Šè¯´æ˜"
                      value="{{foodExperiment.notes}}" bindinput="handleNotesInput"></textarea>
          </view>
          <view class="nutrition-preview {{nutritionLayout === 'grid' ? 'grid' : ''}}" wx:if="{{foodExperiment.nutritionPreview}}">
            <block wx:if="{{nutritionLayout === 'grid'}}">
              <view class="nutrition-item">
                <text>{{foodExperiment.nutritionPreview.calories || 0}} kcal</text>
                <text>çƒ­é‡</text>
              </view>
              <view class="nutrition-item">
                <text>{{foodExperiment.nutritionPreview.protein || 0}} g</text>
                <text>è›‹ç™½è´¨</text>
              </view>
              <view class="nutrition-item">
                <text>{{foodExperiment.nutritionPreview.carbs || 0}} g</text>
                <text>ç¢³æ°´</text>
              </view>
              <view class="nutrition-item">
                <text>{{foodExperiment.nutritionPreview.fat || 0}} g</text>
                <text>è„‚è‚ª</text>
              </view>
            </block>
            <block wx:else>
              <view class="preview-row">
                <text>çƒ­é‡</text>
                <text>{{foodExperiment.nutritionPreview.calories || 0}} kcal</text>
              </view>
              <view class="preview-row">
                <text>è›‹ç™½</text>
                <text>{{foodExperiment.nutritionPreview.protein || 0}} g</text>
              </view>
              <view class="preview-row">
                <text>ç¢³æ°´</text>
                <text>{{foodExperiment.nutritionPreview.carbs || 0}} g</text>
              </view>
              <view class="preview-row">
                <text>è„‚è‚ª</text>
                <text>{{foodExperiment.nutritionPreview.fat || 0}} g</text>
              </view>
              <view class="preview-row">
                <text>è†³çº¤</text>
                <text>{{foodExperiment.nutritionPreview.fiber || 0}} g</text>
              </view>
              <view class="preview-row">
                <text>é’ </text>
                <text>{{foodExperiment.nutritionPreview.sodium || 0}} mg</text>
              </view>
            </block>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer" wx:if="{{step === 'select'}}">
      <button class="modal-btn cancel" bindtap="handleClose">{{selectCancelText}}</button>
      <button class="modal-btn confirm" bindtap="handleConfirmSelect" disabled="{{confirmDisabled}}">{{selectConfirmText}}</button>
    </view>
    <view class="modal-footer" wx:if="{{step === 'form'}}">
      <button class="modal-btn cancel" bindtap="handleFormCancel">{{formCancelText}}</button>
      <button class="modal-btn confirm" bindtap="handleFormSave">{{formConfirmText}}</button>
    </view>
  </view>
</view>
